<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perlas del Conchos - Calendario de Eventos</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 0.5rem;
            margin: 0;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 0;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 1.5rem 1rem;
            border-radius: 15px;
            margin-bottom: 1rem;
            text-align: center;
            position: relative;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #764ba2;
            font-size: 2rem;
            margin-bottom: 0.5rem;
            font-weight: 700;
            line-height: 1.2;
        }

        .header p {
            color: #667eea;
            font-size: 1rem;
            font-weight: 500;
            margin: 0;
        }

        .admin-buttons {
            position: static;
            margin-top: 1rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            justify-content: center;
        }

        .admin-btn {
            background: #764ba2;
            color: white;
            border: none;
            padding: 0.75rem 1rem;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            flex: 1;
            min-width: 120px;
            max-width: 150px;
        }

        .admin-btn:hover, .admin-btn:active {
            background: #6c5ce7;
            transform: translateY(-1px);
        }

        .super-admin-btn {
            background: #e74c3c;
        }

        .super-admin-btn:hover, .super-admin-btn:active {
            background: #c0392b;
        }

        /* Mobile-optimized access button */
        .mobile-admin-access {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: #764ba2;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .mobile-admin-access:active {
            transform: scale(0.95);
        }

        .calendar-section {
            background: rgba(255, 255, 255, 0.95);
            padding: 2rem;
            border-radius: 20px;
            margin-bottom: 2rem;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .calendar-nav {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .nav-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 0.75rem 1rem;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .nav-btn:hover {
            background: #5a67d8;
            transform: translateY(-2px);
        }

        .current-month {
            font-size: 1.5rem;
            font-weight: 700;
            color: #764ba2;
            min-width: 200px;
            text-align: center;
        }

        .calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            background: #e0e7ff;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .day-header {
            background: #667eea;
            color: white;
            padding: 1rem;
            text-align: center;
            font-weight: 700;
            font-size: 1rem;
        }

        .day {
            background: white;
            padding: 0.75rem 0.5rem;
            min-height: 120px;
            position: relative;
            transition: all 0.3s ease;
        }

        .day:hover {
            background: #f8f9ff;
        }

        .day-number {
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: #333;
        }

        .day.other-month {
            opacity: 0.3;
        }

        .day.today {
            background: linear-gradient(135deg, #667eea, #764ba2);
        }

        .day.today .day-number {
            color: white;
        }

        .event {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 0.25rem 0.5rem;
            margin-bottom: 0.25rem;
            border-radius: 8px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .event:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .event.turistico { background: linear-gradient(135deg, #48bb78, #38a169); }
        .event.cultural { background: linear-gradient(135deg, #ed8936, #dd6b20); }
        .event.gastronomico { background: linear-gradient(135deg, #f56565, #e53e3e); }
        .event.deportivo { background: linear-gradient(135deg, #4299e1, #3182ce); }
        .event.religioso { background: linear-gradient(135deg, #805ad5, #6b46c1); }
        .event.educativo { background: linear-gradient(135deg, #38b2ac, #319795); }
        .event.comercial { background: linear-gradient(135deg, #ecc94b, #d69e2e); }

        .admin-panel {
            background: rgba(255, 255, 255, 0.95);
            padding: 1rem;
            border-radius: 15px;
            margin-bottom: 1rem;
            display: none;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .admin-header {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-bottom: 1.5rem;
            border-bottom: 3px solid #e0e7ff;
            padding-bottom: 1rem;
        }

        .admin-nav {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 0.5rem;
        }

        .admin-nav button {
            background: #667eea;
            color: white;
            border: none;
            padding: 0.75rem 0.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 0.85rem;
            text-align: center;
        }

        .admin-nav button:hover, .admin-nav button:active {
            background: #5a67d8;
            transform: scale(1.02);
        }

        .admin-nav button.active {
            background: #764ba2;
        }

        .logout-btn {
            background: #e53e3e !important;
        }

        .logout-btn:hover, .logout-btn:active {
            background: #c53030 !important;
        }

        .form-section {
            background: #f8f9ff;
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 1.5rem;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #4a5568;
            font-size: 0.9rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
            -webkit-appearance: none;
            appearance: none;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 1rem;
        }

        .btn:hover, .btn:active {
            background: #5a67d8;
            transform: scale(1.02);
        }

        .btn-danger {
            background: #e53e3e;
        }

        .btn-danger:hover, .btn-danger:active {
            background: #c53030;
        }

        .event-list {
            display: grid;
            gap: 1rem;
        }

        .event-card {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 15px;
            padding: 1rem;
            transition: all 0.3s ease;
        }

        .event-card:hover, .event-card:active {
            border-color: #667eea;
            transform: scale(1.01);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .event-card h3 {
            color: #764ba2;
            margin-bottom: 0.75rem;
            font-size: 1.1rem;
            line-height: 1.3;
        }

        .event-meta {
            display: grid;
            grid-template-columns: 1fr;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .event-meta p {
            color: #4a5568;
            font-size: 0.9rem;
            margin: 0;
            line-height: 1.4;
        }

        .event-meta strong {
            color: #2d3748;
        }

        .event-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .btn-small {
            padding: 0.75rem 1rem;
            font-size: 0.9rem;
            border-radius: 8px;
            font-weight: 600;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            padding: 1rem;
            box-sizing: border-box;
        }

        .modal-content {
            background: white;
            margin: 2rem auto;
            padding: 1.5rem;
            border-radius: 15px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        .close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 2rem;
            font-weight: bold;
            cursor: pointer;
            color: #aaa;
            transition: color 0.3s ease;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: #f7f7f7;
        }

        .close:hover, .close:active {
            color: #333;
            background: #e0e0e0;
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-top: 2rem;
        }

        .login-form input {
            padding: 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1rem;
            -webkit-appearance: none;
            appearance: none;
        }

        .login-form input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .message {
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 1rem;
            font-weight: 600;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .success {
            background: #c6f6d5;
            color: #2f855a;
            border: 2px solid #9ae6b4;
        }

        .error {
            background: #fed7d7;
            color: #c53030;
            border: 2px solid #feb2b2;
        }

        .info {
            background: #bee3f8;
            color: #2b6cb0;
            border: 2px solid #90cdf4;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 1.5rem;
            border-radius: 15px;
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .user-management {
            background: #f8f9ff;
            padding: 1rem;
            border-radius: 15px;
            margin-bottom: 1.5rem;
        }

        .user-list {
            display: grid;
            gap: 1rem;
        }

        .user-card {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .user-card .user-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
        }

        /* Touch-friendly improvements */
        button, .btn, .filter-btn, .nav-btn, .admin-btn {
            min-height: 44px;
            touch-action: manipulation;
        }

        input, select, textarea {
            min-height: 44px;
            touch-action: manipulation;
        }

        .filters {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .filter-btn {
            background: white;
            border: 2px solid #667eea;
            color: #667eea;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .filter-btn.active,
        .filter-btn:hover {
            background: #667eea;
            color: white;
        }

        @media (max-width: 768px) {
            .container {
                padding: 0.25rem;
            }

            .header {
                padding: 1rem;
                margin-bottom: 0.75rem;
            }

            .header h1 {
                font-size: 1.75rem;
                line-height: 1.2;
            }

            .header p {
                font-size: 0.9rem;
            }

            .admin-buttons {
                margin-top: 0.75rem;
                gap: 0.25rem;
            }

            .admin-btn {
                padding: 0.6rem 0.75rem;
                font-size: 0.8rem;
                min-width: 100px;
                max-width: 120px;
            }

            .calendar-section {
                padding: 0.75rem;
                margin-bottom: 0.75rem;
            }

            .calendar-header {
                gap: 0.75rem;
                margin-bottom: 1rem;
            }

            .current-month {
                font-size: 1.1rem;
            }

            .nav-btn {
                padding: 0.75rem;
                font-size: 1rem;
                min-width: 50px;
            }

            .day {
                min-height: 60px;
                padding: 0.25rem 0.1rem;
            }

            .day-number {
                font-size: 0.8rem;
                margin-bottom: 0.1rem;
            }

            .event {
                font-size: 0.6rem;
                padding: 0.15rem 0.2rem;
                margin-bottom: 0.1rem;
                border-radius: 3px;
            }

            .day-header {
                padding: 0.5rem 0.1rem;
                font-size: 0.8rem;
            }

            .filters {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.5rem;
                margin-bottom: 1rem;
            }

            .filter-btn {
                padding: 0.6rem 0.25rem;
                font-size: 0.75rem;
            }

            .admin-panel {
                padding: 0.75rem;
                margin-bottom: 0.75rem;
            }

            .admin-header {
                gap: 0.75rem;
                margin-bottom: 1rem;
            }

            .admin-nav {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.5rem;
            }

            .admin-nav button {
                padding: 0.6rem 0.25rem;
                font-size: 0.75rem;
            }

            .form-section {
                padding: 0.75rem;
                margin-bottom: 1rem;
            }

            .form-group label {
                font-size: 0.85rem;
            }

            .form-group input,
            .form-group select,
            .form-group textarea {
                padding: 0.75rem;
                font-size: 0.9rem;
            }

            .event-card {
                padding: 0.75rem;
            }

            .event-card h3 {
                font-size: 1rem;
                margin-bottom: 0.5rem;
            }

            .event-meta p {
                font-size: 0.8rem;
            }

            .modal {
                padding: 0.5rem;
            }

            .modal-content {
                margin: 1rem auto;
                padding: 1rem;
                max-height: 95vh;
            }

            .close {
                top: 0.5rem;
                right: 0.5rem;
                width: 35px;
                height: 35px;
                font-size: 1.5rem;
            }

            .login-form {
                margin-top: 1.5rem;
            }

            .stats-grid {
                gap: 0.75rem;
                margin-bottom: 1rem;
            }

            .stat-card {
                padding: 1rem;
            }

            .stat-number {
                font-size: 1.5rem;
            }

            .user-management {
                padding: 0.75rem;
                margin-bottom: 1rem;
            }

            .user-card {
                padding: 0.75rem;
            }

            /* Hide desktop admin access, show mobile button */
            .admin-buttons {
                display: none !important;
            }

            .mobile-admin-access {
                display: flex !important;
            }
        }

        @media (min-width: 769px) {
            .mobile-admin-access {
                display: none !important;
            }

            .admin-buttons {
                display: flex !important;
            }

            .form-grid {
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                gap: 1.5rem;
            }

            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }

            .event-meta {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }

            .event-actions {
                display: flex;
                justify-content: flex-start;
            }

            .user-card {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }

            .user-card .user-actions {
                display: flex;
                gap: 0.5rem;
                grid-template-columns: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>🌊 Perlas del Conchos</h1>
            <p>Calendario de Eventos - Región Centro Sur</p>
            <div class="admin-buttons" id="adminButtons" style="display: none;">
                <button class="admin-btn" onclick="showLogin()">👤 Admin Municipal</button>
                <button class="admin-btn super-admin-btn" onclick="showSuperAdminLogin()">⚙️ Super Admin</button>
                <button class="admin-btn" onclick="showHelp()" style="background: #2d3748;">❓ Ayuda</button>
            </div>
        </div>

        <!-- Mobile Admin Access Button -->
        <button class="mobile-admin-access" onclick="toggleAdminAccess()" title="Acceso administrativo">
            ⚙️
        </button>

        <!-- Super Admin Panel -->
        <div class="admin-panel" id="superAdminPanel">
            <div class="admin-header">
                <div>
                    <h2 style="color: #e74c3c;">🔧 Panel Super Administrador</h2>
                    <p style="color: #667eea;">Gestión de usuarios y sistema</p>
                </div>
                <div class="admin-nav">
                    <button onclick="showUserManagement()" class="active">👥 Usuarios</button>
                    <button onclick="showSystemStats()">📊 Estadísticas</button>
                    <button onclick="showBackup()">💾 Respaldo</button>
                    <button onclick="showAdminInstructions()">📖 Instrucciones</button>
                    <button onclick="backToPublic()">🏠 Ver Calendario Público</button>
                    <button class="logout-btn" onclick="logout()">Salir</button>
                </div>
            </div>

            <div id="messages"></div>

            <!-- User Management -->
            <div id="userManagement">
                <div class="user-management">
                    <h3 style="color: #764ba2; margin-bottom: 1.5rem;">👥 Gestión de Usuarios</h3>
                    
                    <!-- Add User Form -->
                    <div class="form-section">
                        <h4 style="margin-bottom: 1rem;">➕ Agregar Nuevo Usuario</h4>
                    <div style="background: #e6fffa; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; font-size: 0.9rem;">
                        <p><strong>💡 Instrucciones:</strong></p>
                        <ul style="margin-left: 1rem; margin-top: 0.5rem;">
                            <li><strong>Usuario:</strong> Solo letras minúsculas, sin espacios (ej: delicias, meoqui)</li>
                            <li><strong>Contraseña:</strong> Mínimo 6 caracteres, combina letras y números</li>
                            <li><strong>Municipio:</strong> Nombre oficial del municipio</li>
                            <li><strong>Nombre Completo:</strong> Como aparecerá en el sistema</li>
                        </ul>
                    </div>
                        <form onsubmit="addUser(event)">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>Usuario *</label>
                                    <input type="text" id="newUsername" placeholder="ej: delicias" required>
                                </div>
                                <div class="form-group">
                                    <label>Contraseña *</label>
                                    <input type="password" id="newPassword" placeholder="Contraseña segura" required>
                                </div>
                                <div class="form-group">
                                    <label>Municipio *</label>
                                    <input type="text" id="newMunicipality" placeholder="ej: Delicias" required>
                                </div>
                                <div class="form-group">
                                    <label>Nombre Completo *</label>
                                    <input type="text" id="newDisplayName" placeholder="ej: Administrador Delicias" required>
                                </div>
                            </div>
                            <button type="submit" class="btn">➕ Agregar Usuario</button>
                        </form>
                    </div>

                    <!-- User List -->
                    <div>
                        <h4 style="margin-bottom: 1rem;">📋 Usuarios Registrados</h4>
                        <div id="userList" class="user-list"></div>
                    </div>
                </div>
            </div>

            <!-- System Stats -->
            <div id="systemStats" style="display: none;">
                <h3 style="color: #764ba2; margin-bottom: 1.5rem;">📊 Estadísticas del Sistema</h3>
                <div class="stats-grid" id="statsContainer"></div>
            </div>

            <!-- Admin Instructions -->
            <div id="adminInstructions" style="display: none;">
                <h3 style="color: #764ba2; margin-bottom: 1.5rem;">📖 Instrucciones para Administradores</h3>
                
                <div class="form-section">
                    <h4 style="color: #e74c3c; margin-bottom: 1rem;">🔧 SUPER ADMINISTRADOR - Instrucciones</h4>
                    
                    <div style="background: #fff5f5; padding: 1.5rem; border-radius: 10px; margin-bottom: 2rem; border-left: 4px solid #e74c3c;">
                        <h5 style="color: #e74c3c; margin-bottom: 1rem;">🔥 Configurar Firebase Firestore</h5>
                        <p style="margin-bottom: 1rem;"><strong>⚠️ IMPORTANTE:</strong> Para que funcione para el público general, configura Firebase Firestore.</p>
                        <p style="margin-bottom: 1rem;"><strong>📝 Pasos:</strong></p>
                        <ol style="margin-left: 1.5rem; margin-bottom: 1rem;">
                            <li>Ve a Firebase Console → tu proyecto</li>
                            <li>Clic en "Firestore Database" → "Create database"</li>
                            <li>Selecciona "Start in test mode"</li>
                            <li>Ubicación: us-central (o más cercana)</li>
                            <li>En "Rules", pega este código:</li>
                        </ol>
                        <div style="background: #2d3748; color: #e2e8f0; padding: 1rem; border-radius: 5px; font-family: monospace; font-size: 0.8rem; margin-bottom: 1rem;">
rules_version = '2';<br>
service cloud.firestore {<br>
&nbsp;&nbsp;match /databases/{database}/documents {<br>
&nbsp;&nbsp;&nbsp;&nbsp;match /events/{document} {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;allow read: if true;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;allow write: if request.auth != null;<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&nbsp;&nbsp;&nbsp;&nbsp;match /usuarios_autorizados/{document} {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;allow read: if true;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;allow write: if request.auth != null;<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&nbsp;&nbsp;}<br>
}
                        </div>
                        <p style="background: #fef5e7; padding: 0.5rem; border-radius: 5px; font-size: 0.9rem;">
                            💡 <strong>Resultado:</strong> Los eventos serán visibles para todos desde cualquier dispositivo.
                        </p>
                    </div>

                    <div style="background: #f0fff4; padding: 1.5rem; border-radius: 10px; margin-bottom: 2rem; border-left: 4px solid #48bb78;">
                        <h5 style="color: #2f855a; margin-bottom: 1rem;">🔐 Cambiar Credenciales de Super Admin</h5>
                        <p style="margin-bottom: 1rem;"><strong>⚠️ IMPORTANTE:</strong> Para mayor seguridad, cambia las credenciales por defecto.</p>
                        <p style="margin-bottom: 1rem;"><strong>📝 Cómo hacerlo:</strong></p>
                        <ol style="margin-left: 1.5rem; margin-bottom: 1rem;">
                            <li>Ve a GitHub → tu repositorio → archivo <code>index.html</code></li>
                            <li>Busca la línea que dice: <code>username: 'admin', password: 'perlas2024!'</code></li>
                            <li>Cambia 'admin' y 'perlas2024!' por tus nuevas credenciales</li>
                            <li>Guarda los cambios</li>
                        </ol>
                        <p style="background: #fef5e7; padding: 0.5rem; border-radius: 5px; font-size: 0.9rem;">
                            💡 <strong>Tip:</strong> Usa una contraseña segura con mayúsculas, números y símbolos.
                        </p>
                    </div>

                    <div style="background: #f0fff4; padding: 1.5rem; border-radius: 10px; margin-bottom: 2rem; border-left: 4px solid #48bb78;">
                        <h5 style="color: #2f855a; margin-bottom: 1rem;">👥 Gestión de Usuarios Municipales</h5>
                        
                        <h6 style="color: #2d3748; margin-bottom: 0.5rem;">➕ Para agregar un nuevo municipio:</h6>
                        <ol style="margin-left: 1.5rem; margin-bottom: 1rem;">
                            <li><strong>Usuario:</strong> Nombre del municipio en minúsculas (ej: delicias, meoqui)</li>
                            <li><strong>Contraseña:</strong> Crea una contraseña segura</li>
                            <li><strong>Municipio:</strong> Nombre completo con mayúscula (ej: Delicias)</li>
                            <li><strong>Nombre Completo:</strong> Como aparecerá en el sistema (ej: Administrador Delicias)</li>
                            <li>Haz clic en "➕ Agregar Usuario"</li>
                        </ol>

                        <h6 style="color: #2d3748; margin-bottom: 0.5rem;">🔧 Para gestionar usuarios existentes:</h6>
                        <ul style="margin-left: 1.5rem; margin-bottom: 1rem;">
                            <li><strong>🚫 Desactivar:</strong> El usuario no podrá hacer login pero conserva sus eventos</li>
                            <li><strong>✅ Activar:</strong> Reactiva un usuario desactivado</li>
                            <li><strong>🗑️ Eliminar:</strong> ⚠️ Borra el usuario Y todos sus eventos (no se puede deshacer)</li>
                        </ul>
                    </div>

                    <div style="background: #edf2f7; padding: 1.5rem; border-radius: 10px; margin-bottom: 2rem; border-left: 4px solid #4a5568;">
                        <h5 style="color: #2d3748; margin-bottom: 1rem;">💾 Sistema de Respaldos</h5>
                        
                        <h6 style="color: #2d3748; margin-bottom: 0.5rem;">📥 Hacer Respaldo (Recomendado semanal):</h6>
                        <ol style="margin-left: 1.5rem; margin-bottom: 1rem;">
                            <li>Ve a la sección "💾 Respaldo"</li>
                            <li>Haz clic en "📥 Descargar Respaldo"</li>
                            <li>Se descargará un archivo .json con todos los datos</li>
                            <li>Guárdalo en un lugar seguro (Google Drive, OneDrive, etc.)</li>
                        </ol>

                        <h6 style="color: #2d3748; margin-bottom: 0.5rem;">📤 Restaurar Respaldo:</h6>
                        <ol style="margin-left: 1.5rem; margin-bottom: 1rem;">
                            <li>Ve a la sección "💾 Respaldo"</li>
                            <li>Haz clic en "📤 Importar Respaldo"</li>
                            <li>Selecciona el archivo .json del respaldo</li>
                            <li>⚠️ Esto reemplazará TODOS los datos actuales</li>
                        </ol>
                    </div>

                    <div style="background: #e6fffa; padding: 1.5rem; border-radius: 10px; border-left: 4px solid #319795;">
                        <h5 style="color: #2c7a7b; margin-bottom: 1rem;">📊 Monitoreo del Sistema</h5>
                        <ul style="margin-left: 1.5rem;">
                            <li><strong>📊 Estadísticas:</strong> Revisa regularmente las estadísticas para ver el uso del sistema</li>
                            <li><strong>👥 Usuarios Activos:</strong> Verifica que solo usuarios autorizados tengan acceso</li>
                            <li><strong>📅 Eventos:</strong> Supervisa la calidad y cantidad de eventos publicados</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Backup -->
            <div id="backupSection" style="display: none;">
                <h3 style="color: #764ba2; margin-bottom: 1.5rem;">💾 Respaldo y Restauración</h3>
                <div class="form-section">
                    <button class="btn" onclick="exportData()">📥 Descargar Respaldo</button>
                    <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">
                    <button class="btn" onclick="document.getElementById('importFile').click()">📤 Importar Respaldo</button>
                </div>
            </div>
        </div>

        <!-- Admin Panel -->
        <div class="admin-panel" id="adminPanel">
            <div class="admin-header">
                <div>
                    <h2 style="color: #764ba2;">📋 Panel Municipal</h2>
                    <p style="color: #667eea;" id="userInfo">Usuario conectado</p>
                </div>
                <div class="admin-nav">
                    <button onclick="showAddForm()" class="active">➕ Agregar</button>
                    <button onclick="showEventList()">📋 Mis Eventos</button>
                    <button onclick="showMyStats()">📊 Estadísticas</button>
                    <button onclick="backToPublic()">🏠 Ver Calendario Público</button>
                    <button class="logout-btn" onclick="logout()">Salir</button>
                </div>
            </div>

            <div id="adminMessages"></div>

            <!-- Add Event Form -->
            <div id="addForm">
                <div class="form-section">
                    <h3 style="color: #764ba2; margin-bottom: 1rem;">🎉 Nuevo Evento</h3>
                    
                    <div style="background: #e6fffa; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; font-size: 0.9rem;">
                        <p><strong>💡 Consejos para un buen evento:</strong></p>
                        <ul style="margin-left: 1rem; margin-top: 0.5rem;">
                            <li><strong>Título:</strong> Sé específico y atractivo (ej: "Festival de la Nuez 2025")</li>
                            <li><strong>Descripción:</strong> Incluye actividades, horarios especiales, y qué pueden esperar los asistentes</li>
                            <li><strong>Ubicación:</strong> Dirección completa + referencias conocidas</li>
                            <li><strong>Contacto:</strong> Número de WhatsApp o teléfono para consultas</li>
                        </ul>
                    </div>
                    
                    <form onsubmit="saveEvent(event)">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>📝 Título del evento *</label>
                                <input type="text" id="title" placeholder="ej: Festival de la Nuez" required>
                            </div>
                            <div class="form-group">
                                <label>📅 Fecha *</label>
                                <input type="date" id="date" required>
                            </div>
                            <div class="form-group">
                                <label>⏰ Hora *</label>
                                <input type="time" id="time" required>
                            </div>
                            <div class="form-group">
                                <label>🏷️ Tipo de evento *</label>
                                <select id="type" required>
                                    <option value="">Seleccionar tipo</option>
                                    <option value="turistico">🏞️ Turístico</option>
                                    <option value="cultural">🎭 Cultural</option>
                                    <option value="gastronomico">🍽️ Gastronómico</option>
                                    <option value="deportivo">⚽ Deportivo</option>
                                    <option value="religioso">⛪ Religioso/Tradicional</option>
                                    <option value="educativo">📚 Educativo</option>
                                    <option value="comercial">🛍️ Comercial/Feria</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>💰 Costo *</label>
                                <input type="text" id="cost" placeholder="ej: Gratuito, $100 MXN" required>
                            </div>
                            <div class="form-group">
                                <label>📞 Contacto/Teléfono *</label>
                                <input type="text" id="contact" placeholder="ej: 636-123-4567" required>
                            </div>
                            <div class="form-group full-width">
                                <label>📍 Ubicación completa *</label>
                                <input type="text" id="location" placeholder="ej: Plaza Principal, Centro Histórico" required>
                            </div>
                            <div class="form-group full-width">
                                <label>🏢 Organizador *</label>
                                <input type="text" id="organizer" placeholder="ej: Municipio de Delicias" required>
                            </div>
                            <div class="form-group full-width">
                                <label>📋 Descripción del evento *</label>
                                <textarea id="description" rows="4" placeholder="Describe el evento, actividades incluidas, etc." required></textarea>
                            </div>
                            <div class="form-group full-width" style="text-align: center;">
                                <button type="submit" class="btn">💾 Guardar Evento</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Event List -->
            <div id="eventList" style="display: none;">
                <h3 style="color: #764ba2; margin-bottom: 1.5rem;">📋 Mis Eventos</h3>
                <div class="filters">
                    <button class="filter-btn active" onclick="filterEvents('all')">📅 Todos</button>
                    <button class="filter-btn" onclick="filterEvents('upcoming')">⏭️ Próximos</button>
                    <button class="filter-btn" onclick="filterEvents('past')">⏮️ Pasados</button>
                </div>
                <div id="userEvents" class="event-list"></div>
            </div>

            <!-- My Stats -->
            <div id="myStats" style="display: none;">
                <h3 style="color: #764ba2; margin-bottom: 1.5rem;">📊 Mis Estadísticas</h3>
                <div class="stats-grid" id="myStatsContainer"></div>
            </div>
        </div>

        <!-- Calendar -->
        <div class="calendar-section">
            <div class="calendar-header">
                <h3 style="color: #764ba2;">📅 Calendario de Eventos Públicos</h3>
                <div class="calendar-nav">
                    <button class="nav-btn" onclick="previousMonth()">← Anterior</button>
                    <div class="current-month" id="currentMonth"></div>
                    <button class="nav-btn" onclick="nextMonth()">Siguiente →</button>
                </div>
            </div>
            
            <!-- Event Type Filters -->
            <div class="filters">
                <button class="filter-btn active" onclick="filterCalendar('all')">📅 Todos</button>
                <button class="filter-btn" onclick="filterCalendar('turistico')">🏞️ Turístico</button>
                <button class="filter-btn" onclick="filterCalendar('cultural')">🎭 Cultural</button>
                <button class="filter-btn" onclick="filterCalendar('gastronomico')">🍽️ Gastronómico</button>
                <button class="filter-btn" onclick="filterCalendar('deportivo')">⚽ Deportivo</button>
                <button class="filter-btn" onclick="filterCalendar('religioso')">⛪ Religioso</button>
                <button class="filter-btn" onclick="filterCalendar('educativo')">📚 Educativo</button>
                <button class="filter-btn" onclick="filterCalendar('comercial')">🛍️ Comercial</button>
            </div>
            
            <div class="calendar" id="calendar">
                <!-- Calendar generated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Login Modals -->
    <div id="loginModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeLogin()">&times;</span>
            <h2 style="color: #764ba2; text-align: center;">👤 Acceso Municipal</h2>
            <form class="login-form" onsubmit="login(event)">
                <input type="text" id="username" placeholder="Usuario del municipio" required>
                <input type="password" id="password" placeholder="Contraseña" required>
                <button type="submit" class="btn">Ingresar</button>
            </form>
            <div style="margin-top: 1rem; padding: 1rem; background: #e6fffa; border-radius: 8px; font-size: 0.9rem;">
                <strong>ℹ️ Para obtener acceso:</strong><br>
                Contacta al administrador del sistema para que te asigne un usuario y contraseña.<br><br>
                <strong>Usuario de prueba:</strong><br>
                Usuario: delicias<br>
                Contraseña: 123
            </div>
        </div>
    </div>

    <div id="superAdminLoginModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeSuperAdminLogin()">&times;</span>
            <h2 style="color: #e74c3c; text-align: center;">⚙️ Super Administrador</h2>
            <form class="login-form" onsubmit="superAdminLogin(event)">
                <input type="text" id="superUsername" placeholder="Usuario administrador" required>
                <input type="password" id="superPassword" placeholder="Contraseña maestra" required>
                <button type="submit" class="btn">Ingresar</button>
            </form>
            <div style="margin-top: 1rem; padding: 1rem; background: #fff5f5; border-radius: 8px; font-size: 0.9rem;">
                <strong>⚠️ Acceso restringido:</strong><br>
                Solo para el administrador principal del sistema.<br><br>
                <strong>Credenciales de prueba:</strong><br>
                Usuario: admin<br>
                Contraseña: perlas2024!
            </div>
        </div>
    </div>

    <!-- Help Modal -->
    <div id="helpModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <span class="close" onclick="closeHelp()">&times;</span>
            <h2 style="color: #764ba2; text-align: center; margin-bottom: 2rem;">❓ Manual de Usuario - Perlas del Conchos</h2>
            
            <div style="background: #f8f9ff; padding: 2rem; border-radius: 15px; margin-bottom: 2rem;">
                <h3 style="color: #764ba2; margin-bottom: 1rem;">🎯 ¿Qué es este sistema?</h3>
                <p style="margin-bottom: 1rem;">Es un calendario digital donde los municipios de la región pueden publicar sus eventos públicos. Los ciudadanos pueden ver todos los eventos escaneando un código QR.</p>
                
                <h4 style="color: #667eea; margin-bottom: 0.5rem;">👥 Hay dos tipos de usuarios:</h4>
                <ul style="margin-left: 1.5rem; margin-bottom: 1rem;">
                    <li><strong>📋 Administradores Municipales:</strong> Pueden agregar, editar y eliminar eventos de su municipio</li>
                    <li><strong>⚙️ Super Administrador:</strong> Puede gestionar usuarios y hacer respaldos del sistema</li>
                </ul>
            </div>

            <div style="background: #e6fffa; padding: 2rem; border-radius: 15px; margin-bottom: 2rem;">
                <h3 style="color: #2c7a7b; margin-bottom: 1rem;">👤 Para Administradores Municipales</h3>
                
                <h4 style="color: #2d3748; margin-bottom: 0.5rem;">🔐 Cómo acceder:</h4>
                <ol style="margin-left: 1.5rem; margin-bottom: 1rem;">
                    <li>Haz clic en el ícono ⚙️ (esquina inferior derecha)</li>
                    <li>Clic en "👤 Admin Municipal"</li>
                    <li>Ingresa tu usuario y contraseña (proporcionados por el super admin)</li>
                </ol>

                <h4 style="color: #2d3748; margin-bottom: 0.5rem;">➕ Cómo agregar un evento:</h4>
                <ol style="margin-left: 1.5rem; margin-bottom: 1rem;">
                    <li>Una vez logueado, estás en "➕ Agregar" automáticamente</li>
                    <li>Llena TODOS los campos obligatorios (*)</li>
                    <li>Haz clic en "💾 Guardar Evento"</li>
                    <li>El evento aparecerá inmediatamente en el calendario público</li>
                </ol>

                <h4 style="color: #2d3748; margin-bottom: 0.5rem;">📋 Cómo gestionar eventos existentes:</h4>
                <ol style="margin-left: 1.5rem; margin-bottom: 1rem;">
                    <li>Clic en "📋 Mis Eventos"</li>
                    <li>Usa los filtros: "📅 Todos", "⏭️ Próximos", "⏮️ Pasados"</li>
                    <li>Para editar: Clic en "✏️ Editar" → Modifica → "💾 Guardar"</li>
                    <li>Para eliminar: Clic en "🗑️ Eliminar" → Confirmar</li>
                </ol>

                <h4 style="color: #2d3748; margin-bottom: 0.5rem;">🔍 Consejos para eventos exitosos:</h4>
                <ul style="margin-left: 1.5rem;">
                    <li><strong>Título:</strong> Que sea atractivo y descriptivo</li>
                    <li><strong>Descripción:</strong> Incluye todas las actividades y detalles importantes</li>
                    <li><strong>Ubicación:</strong> Dirección completa y referencias conocidas</li>
                    <li><strong>Contacto:</strong> Teléfono o email para consultas</li>
                    <li><strong>Tipo:</strong> Selecciona la categoría correcta para que aparezca en filtros</li>
                </ul>
            </div>

            <div style="background: #fff5f5; padding: 2rem; border-radius: 15px;">
                <h3 style="color: #e74c3c; margin-bottom: 1rem;">⚙️ Para Super Administrador</h3>
                
                <h4 style="color: #2d3748; margin-bottom: 0.5rem;">🔐 Responsabilidades principales:</h4>
                <ul style="margin-left: 1.5rem; margin-bottom: 1rem;">
                    <li><strong>👥 Gestión de Usuarios:</strong> Crear cuentas para nuevos municipios</li>
                    <li><strong>💾 Respaldos:</strong> Hacer respaldos semanales del sistema</li>
                    <li><strong>📊 Monitoreo:</strong> Revisar estadísticas y uso del sistema</li>
                    <li><strong>🔒 Seguridad:</strong> Cambiar credenciales por defecto</li>
                </ul>

                <h4 style="color: #2d3748; margin-bottom: 0.5rem;">📞 Contacto y Soporte:</h4>
                <p style="background: #f7fafc; padding: 1rem; border-radius: 8px; font-style: italic;">
                    Para soporte técnico o preguntas sobre el sistema, contacta al desarrollador o consulta la documentación en GitHub.
                </p>
            </div>
        </div>
    </div>
    <div id="eventModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeEventModal()">&times;</span>
            <div id="eventDetails"></div>
        </div>
    </div>

    <script>
        // Variables globales
        let currentUser = null;
        let currentUserType = null; // 'municipal' or 'super'
        let events = [];
        let users = {};
        let currentDate = new Date();
        let currentFilter = 'all';
        let editingEventId = null;

        // Super admin credentials (CAMBIAR ESTAS CREDENCIALES POR SEGURIDAD)
        // Para cambiar: busca esta sección en el código y modifica username y password
        const SUPER_ADMIN = {
            username: 'admin',           // ← Cambiar por tu usuario preferido
            password: 'perlas2024!'      // ← Cambiar por una contraseña segura
        };

        // Inicializar aplicación
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🌊 Perlas del Conchos - Sistema iniciado');
            
            // Esperar a que Firebase esté listo
            waitForFirebase().then(() => {
                loadData(); // Cargar desde Firestore
                setDefaultDate();
                optimizeForMobile();
                setupRealtimeUpdates(); // Configurar actualizaciones en tiempo real
            }).catch(error => {
                console.error('❌ Error inicializando Firebase:', error);
                showMessage('❌ Error conectando con la base de datos. Revisa tu conexión.', 'error');
            });
        });

        // Esperar a que Firebase esté disponible
        function waitForFirebase() {
            return new Promise((resolve, reject) => {
                let attempts = 0;
                const maxAttempts = 30;
                
                const checkFirebase = () => {
                    if (typeof firebase !== 'undefined' && firebase.firestore && db) {
                        console.log('✅ Firebase conectado correctamente');
                        resolve();
                    } else if (attempts < maxAttempts) {
                        attempts++;
                        setTimeout(checkFirebase, 200);
                    } else {
                        reject(new Error('Firebase no se pudo inicializar'));
                    }
                };
                
                checkFirebase();
            });
        }

        // Configurar actualizaciones en tiempo real
        function setupRealtimeUpdates() {
            // Escuchar cambios en eventos en tiempo real
            db.collection('events').onSnapshot((snapshot) => {
                console.log('🔄 Actualizando eventos en tiempo real...');
                events = [];
                snapshot.forEach((doc) => {
                    events.push({ id: doc.id, ...doc.data() });
                });
                
                // Ordenar eventos por fecha
                events.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                // Actualizar interfaz automáticamente
                renderCalendar();
                
                // Si estamos en la vista de eventos del usuario, actualizarla también
                if (currentUser && document.getElementById('eventList').style.display !== 'none') {
                    renderUserEvents();
                }
                
                console.log(`🔄 ${events.length} eventos sincronizados en tiempo real`);
            }, (error) => {
                console.error('❌ Error en sincronización en tiempo real:', error);
            });

            // Escuchar cambios en usuarios autorizados en tiempo real  
            db.collection('usuarios_autorizados').onSnapshot((snapshot) => {
                console.log('🔄 Actualizando usuarios en tiempo real...');
                const newUsers = {};
                snapshot.forEach((doc) => {
                    newUsers[doc.id] = doc.data();
                });
                
                users = newUsers;
                
                // Si estamos en la vista de gestión de usuarios, actualizarla
                if (currentUserType === 'super' && document.getElementById('userManagement').style.display !== 'none') {
                    renderUserList();
                }
                
                console.log(`🔄 ${Object.keys(users).length} usuarios sincronizados en tiempo real`);
            }, (error) => {
                console.error('❌ Error en sincronización de usuarios:', error);
            });
        }

        // Optimizaciones para móvil
        function optimizeForMobile() {
            // Prevent zoom on input focus for iOS
            if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
                const inputs = document.querySelectorAll('input, select, textarea');
                inputs.forEach(input => {
                    if (input.style.fontSize < '16px') {
                        input.style.fontSize = '16px';
                    }
                });
            }

            // Add touch feedback
            const touchElements = document.querySelectorAll('button, .btn, .filter-btn, .nav-btn, .admin-btn, .event');
            touchElements.forEach(element => {
                element.addEventListener('touchstart', function() {
                    this.style.opacity = '0.7';
                });
                
                element.addEventListener('touchend', function() {
                    this.style.opacity = '1';
                });
                
                element.addEventListener('touchcancel', function() {
                    this.style.opacity = '1';
                });
            });

            // Optimize calendar for mobile viewing
            if (window.innerWidth <= 768) {
                // Make events more visible on small screens
                const style = document.createElement('style');
                style.textContent = `
                    @media (max-width: 768px) {
                        .event {
                            min-height: 16px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                        }
                        
                        .day {
                            border: 1px solid #e0e7ff;
                        }
                        
                        .day:active {
                            background: #f0f4ff !important;
                        }
                    }
                `;
                document.head.appendChild(style);
            }
        }

        // Mejorar navegación en calendario para móvil
        function previousMonth() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
            
            // Haptic feedback on mobile
            if ('vibrate' in navigator) {
                navigator.vibrate(50);
            }
        }

        function nextMonth() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
            
            // Haptic feedback on mobile
            if ('vibrate' in navigator) {
                navigator.vibrate(50);
            }
        }

        // Help and Instructions
        function showHelp() {
            document.getElementById('helpModal').style.display = 'block';
        }

        function closeHelp() {
            document.getElementById('helpModal').style.display = 'none';
        }

        function showAdminInstructions() {
            document.getElementById('userManagement').style.display = 'none';
            document.getElementById('systemStats').style.display = 'none';
            document.getElementById('backupSection').style.display = 'none';
            document.getElementById('adminInstructions').style.display = 'block';
            updateNavButtons('📖 Instrucciones');
        }

        // Gestión de datos - Ahora usa Firebase Firestore (base de datos compartida)
        function loadData() {
            // Ya no usar localStorage - todo viene de Firebase
            console.log('📊 Cargando datos desde Firebase Firestore...');
            loadEvents();
            loadAuthorizedUsers();
        }

        // Cargar eventos desde Firestore
        async function loadEvents() {
            try {
                console.log('📅 Cargando eventos desde Firestore...');
                const eventsSnapshot = await db.collection('events').orderBy('date', 'desc').get();
                events = [];
                eventsSnapshot.forEach((doc) => {
                    events.push({ id: doc.id, ...doc.data() });
                });
                console.log(`✅ ${events.length} eventos cargados desde Firestore`);
                renderCalendar(); // Actualizar calendario automáticamente
            } catch (error) {
                console.error('❌ Error cargando eventos:', error);
                events = []; // Array vacío si hay error
            }
        }

        // Cargar usuarios autorizados desde Firestore
        async function loadAuthorizedUsers() {
            try {
                console.log('👥 Cargando usuarios autorizados desde Firestore...');
                const usersSnapshot = await db.collection('usuarios_autorizados').get();
                users = {};
                usersSnapshot.forEach((doc) => {
                    users[doc.id] = doc.data();
                });
                
                // Si no hay usuarios, crear usuario por defecto
                if (Object.keys(users).length === 0) {
                    console.log('🔧 Creando usuario por defecto...');
                    await createDefaultUser();
                }
                
                console.log(`✅ ${Object.keys(users).length} usuarios autorizados cargados desde Firestore`);
            } catch (error) {
                console.error('❌ Error cargando usuarios:', error);
                // Crear usuario por defecto si hay error
                await createDefaultUser();
            }
        }

        // Crear usuario por defecto en Firestore
        async function createDefaultUser() {
            try {
                const defaultUser = {
                    password: '123',
                    municipality: 'Delicias',
                    displayName: 'Administrador Delicias',
                    active: true,
                    created: new Date().toISOString()
                };
                
                await db.collection('usuarios_autorizados').doc('delicias').set(defaultUser);
                users['delicias'] = defaultUser;
                console.log('✅ Usuario por defecto creado en Firestore');
            } catch (error) {
                console.error('❌ Error creando usuario por defecto:', error);
                // Fallback local si no puede crear en Firestore
                users = {
                    'delicias': {
                        password: '123',
                        municipality: 'Delicias',
                        displayName: 'Administrador Delicias',
                        active: true,
                        created: new Date().toISOString()
                    }
                };
            }
        }

        // Guardar evento en Firestore
        async function saveEventToFirestore(eventData) {
            try {
                if (eventData.id && eventData.id !== Date.now()) {
                    // Actualizar evento existente
                    await db.collection('events').doc(eventData.id.toString()).set(eventData);
                    console.log('✅ Evento actualizado en Firestore');
                } else {
                    // Crear nuevo evento
                    const docRef = await db.collection('events').add(eventData);
                    eventData.id = docRef.id;
                    console.log('✅ Evento creado en Firestore con ID:', docRef.id);
                }
                return true;
            } catch (error) {
                console.error('❌ Error guardando evento en Firestore:', error);
                return false;
            }
        }

        // Eliminar evento de Firestore
        async function deleteEventFromFirestore(eventId) {
            try {
                await db.collection('events').doc(eventId.toString()).delete();
                console.log('✅ Evento eliminado de Firestore');
                return true;
            } catch (error) {
                console.error('❌ Error eliminando evento de Firestore:', error);
                return false;
            }
        }

        // Guardar usuario en Firestore
        async function saveUserToFirestore(username, userData) {
            try {
                await db.collection('usuarios_autorizados').doc(username).set(userData);
                console.log('✅ Usuario guardado en Firestore');
                return true;
            } catch (error) {
                console.error('❌ Error guardando usuario en Firestore:', error);
                return false;
            }
        }

        // Eliminar usuario de Firestore
        async function deleteUserFromFirestore(username) {
            try {
                await db.collection('usuarios_autorizados').doc(username).delete();
                console.log('✅ Usuario eliminado de Firestore');
                return true;
            } catch (error) {
                console.error('❌ Error eliminando usuario de Firestore:', error);
                return false;
            }
        }

        function setDefaultDate() {
            const today = new Date();
            const dateStr = today.toISOString().split('T')[0];
            const dateInput = document.getElementById('date');
            if (dateInput) {
                dateInput.value = dateStr;
            }
        }

        // Authentication
        function toggleAdminAccess() {
            const adminButtons = document.getElementById('adminButtons');
            const isMobile = window.innerWidth <= 768;
            
            if (adminButtons.style.display === 'none' || adminButtons.style.display === '') {
                adminButtons.style.display = isMobile ? 'flex' : 'flex';
                showMessage('🔐 Acceso administrativo habilitado', 'info');
                
                // Auto-hide on mobile after 10 seconds
                if (isMobile) {
                    setTimeout(() => {
                        if (adminButtons.style.display === 'flex') {
                            adminButtons.style.display = 'none';
                            showMessage('👥 Modo público activado', 'info');
                        }
                    }, 10000);
                }
            } else {
                adminButtons.style.display = 'none';
                showMessage('👥 Modo público activado', 'info');
            }
        }

        function showLogin() {
            document.getElementById('loginModal').style.display = 'block';
        }

        function closeLogin() {
            document.getElementById('loginModal').style.display = 'none';
            clearMessages();
        }

        function showSuperAdminLogin() {
            document.getElementById('superAdminLoginModal').style.display = 'block';
        }

        function closeSuperAdminLogin() {
            document.getElementById('superAdminLoginModal').style.display = 'none';
            clearMessages();
        }

        function backToPublic() {
            // Hide all admin panels
            document.getElementById('adminPanel').style.display = 'none';
            document.getElementById('superAdminPanel').style.display = 'none';
            
            // Show calendar section
            document.querySelector('.calendar-section').style.display = 'block';
            
            // Hide admin buttons
            document.getElementById('adminButtons').style.display = 'none';
            
            showMessage('🏠 Volviendo al calendario público', 'info');
        }

        function login(event) {
            event.preventDefault();
            const username = document.getElementById('username').value.trim().toLowerCase();
            const password = document.getElementById('password').value;

            if (users[username] && users[username].password === password && users[username].active) {
                currentUser = username;
                currentUserType = 'municipal';
                document.getElementById('userInfo').textContent = 
                    `${users[username].displayName} - ${users[username].municipality}`;
                
                // Hide calendar and show admin panel
                document.querySelector('.calendar-section').style.display = 'none';
                document.getElementById('adminPanel').style.display = 'block';
                
                closeLogin();
                showMessage('✅ Acceso exitoso', 'success', 'adminMessages');
                showAddForm();
                clearForm();
            } else {
                showMessage('❌ Usuario o contraseña incorrectos', 'error');
            }
        }

        function superAdminLogin(event) {
            event.preventDefault();
            const username = document.getElementById('superUsername').value.trim();
            const password = document.getElementById('superPassword').value;

            if (username === SUPER_ADMIN.username && password === SUPER_ADMIN.password) {
                currentUser = 'superadmin';
                currentUserType = 'super';
                
                // Hide calendar and show super admin panel
                document.querySelector('.calendar-section').style.display = 'none';
                document.getElementById('superAdminPanel').style.display = 'block';
                
                closeSuperAdminLogin();
                showMessage('✅ Acceso de super administrador exitoso', 'success', 'messages');
                showUserManagement();
                renderUserList();
                clearForm();
            } else {
                showMessage('❌ Credenciales de super administrador incorrectas', 'error');
            }
        }

        function logout() {
            currentUser = null;
            currentUserType = null;
            
            // Hide admin panels and show calendar
            document.getElementById('adminPanel').style.display = 'none';
            document.getElementById('superAdminPanel').style.display = 'none';
            document.querySelector('.calendar-section').style.display = 'block';
            
            // Hide admin buttons
            document.getElementById('adminButtons').style.display = 'none';
            
            showMessage('👋 Sesión cerrada exitosamente', 'success');
            clearForm();
        }

        // User Management (Super Admin)
        function showUserManagement() {
            document.getElementById('userManagement').style.display = 'block';
            document.getElementById('systemStats').style.display = 'none';
            document.getElementById('backupSection').style.display = 'none';
            updateNavButtons('👥 Usuarios');
            renderUserList();
        }

        function showSystemStats() {
            document.getElementById('userManagement').style.display = 'none';
            document.getElementById('systemStats').style.display = 'block';
            document.getElementById('backupSection').style.display = 'none';
            updateNavButtons('📊 Estadísticas');
            renderSystemStats();
        }

        function showBackup() {
            document.getElementById('userManagement').style.display = 'none';
            document.getElementById('systemStats').style.display = 'none';
            document.getElementById('backupSection').style.display = 'block';
            updateNavButtons('💾 Respaldo');
        }

        function updateNavButtons(activeText) {
            document.querySelectorAll('#superAdminPanel .admin-nav button').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent.includes(activeText)) {
                    btn.classList.add('active');
                }
            });
        }

        function addUser(event) {
            event.preventDefault();
            
            // Obtener datos del formulario y limpiarlos
            const username = document.getElementById('newUsername').value.trim().toLowerCase();
            const password = document.getElementById('newPassword').value;
            const municipality = document.getElementById('newMunicipality').value.trim();
            const displayName = document.getElementById('newDisplayName').value.trim();

            // Validar que el usuario no exista ya
            if (users[username]) {
                showMessage('❌ Error: El usuario ya existe. Usa otro nombre de usuario.', 'error', 'messages');
                return;
            }

            // Validaciones básicas
            if (username.length < 3) {
                showMessage('❌ Error: El usuario debe tener al menos 3 caracteres.', 'error', 'messages');
                return;
            }

            if (password.length < 6) {
                showMessage('❌ Error: La contraseña debe tener al menos 6 caracteres.', 'error', 'messages');
                return;
            }

            // Crear el nuevo usuario
            const userData = {
                password: password,
                municipality: municipality,
                displayName: displayName,
                active: true,
                created: new Date().toISOString()
            };

            // Guardar en Firestore
            saveUserToFirestore(username, userData).then(success => {
                if (success) {
                    users[username] = userData;
                    showMessage(`✅ ¡Éxito! Usuario "${username}" creado correctamente. Ya puede hacer login.`, 'success', 'messages');
                    
                    // Limpiar formulario y actualizar lista
                    document.querySelector('#userManagement form').reset();
                    renderUserList();
                } else {
                    showMessage('❌ Error guardando usuario. Intenta de nuevo.', 'error', 'messages');
                }
            });
        }

        function toggleUser(username) {
            if (users[username]) {
                users[username].active = !users[username].active;
                
                // Guardar cambios en Firestore
                saveUserToFirestore(username, users[username]).then(success => {
                    if (success) {
                        showMessage(`✅ Usuario "${username}" ${users[username].active ? 'activado' : 'desactivado'}`, 'success', 'messages');
                        renderUserList();
                    } else {
                        // Revertir cambio si falla
                        users[username].active = !users[username].active;
                        showMessage('❌ Error actualizando usuario', 'error', 'messages');
                    }
                });
            }
        }

        function deleteUser(username) {
            if (confirm(`¿Estás seguro de eliminar al usuario "${username}"?`)) {
                // Eliminar de Firestore
                deleteUserFromFirestore(username).then(success => {
                    if (success) {
                        delete users[username];
                        
                        // También eliminar eventos de este usuario
                        const userEvents = events.filter(event => event.createdBy === username);
                        const deletePromises = userEvents.map(event => deleteEventFromFirestore(event.id));
                        
                        Promise.all(deletePromises).then(() => {
                            // Actualizar array local de eventos
                            events = events.filter(event => event.createdBy !== username);
                            
                            showMessage(`✅ Usuario "${username}" eliminado`, 'success', 'messages');
                            renderUserList();
                            renderCalendar();
                        });
                    } else {
                        showMessage('❌ Error eliminando usuario', 'error', 'messages');
                    }
                });
            }
        }

        function renderUserList() {
            const container = document.getElementById('userList');
            const userEntries = Object.entries(users);

            if (userEntries.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 2rem;">No hay usuarios registrados.</p>';
                return;
            }

            container.innerHTML = userEntries.map(([username, userData]) => `
                <div class="user-card">
                    <div>
                        <h4 style="color: #764ba2;">${userData.displayName}</h4>
                        <p style="color: #666; margin: 0.25rem 0;">👤 Usuario: ${username}</p>
                        <p style="color: #666; margin: 0.25rem 0;">🏛️ Municipio: ${userData.municipality}</p>
                        <p style="color: #666; margin: 0.25rem 0;">📅 Creado: ${formatDateTime(userData.created)}</p>
                        <span style="padding: 0.25rem 0.5rem; border-radius: 5px; font-size: 0.8rem; 
                              background: ${userData.active ? '#c6f6d5' : '#fed7d7'}; 
                              color: ${userData.active ? '#2f855a' : '#c53030'};">
                            ${userData.active ? '✅ Activo' : '❌ Inactivo'}
                        </span>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                        <button class="btn-small ${userData.active ? 'btn-danger' : 'btn'}" 
                                onclick="toggleUser('${username}')">
                            ${userData.active ? '🚫 Desactivar' : '✅ Activar'}
                        </button>
                        <button class="btn-small btn-danger" onclick="deleteUser('${username}')">
                            🗑️ Eliminar
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function renderSystemStats() {
            const totalEvents = events.length;
            const totalUsers = Object.keys(users).length;
            const activeUsers = Object.values(users).filter(u => u.active).length;
            const upcomingEvents = events.filter(e => new Date(e.date) >= new Date()).length;
            
            const eventsByType = {};
            events.forEach(event => {
                eventsByType[event.type] = (eventsByType[event.type] || 0) + 1;
            });

            const eventsByMunicipality = {};
            events.forEach(event => {
                const municipality = users[event.createdBy]?.municipality || 'Desconocido';
                eventsByMunicipality[municipality] = (eventsByMunicipality[municipality] || 0) + 1;
            });

            document.getElementById('statsContainer').innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${totalEvents}</div>
                    <div class="stat-label">📅 Total de Eventos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${totalUsers}</div>
                    <div class="stat-label">👥 Total de Usuarios</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${activeUsers}</div>
                    <div class="stat-label">✅ Usuarios Activos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${upcomingEvents}</div>
                    <div class="stat-label">⏭️ Eventos Próximos</div>
                </div>
            `;
        }

        // Event Management
        function showAddForm() {
            document.getElementById('addForm').style.display = 'block';
            document.getElementById('eventList').style.display = 'none';
            document.getElementById('myStats').style.display = 'none';
            updateAdminNavButtons('➕ Agregar');
            editingEventId = null;
        }

        function showEventList() {
            document.getElementById('addForm').style.display = 'none';
            document.getElementById('eventList').style.display = 'block';
            document.getElementById('myStats').style.display = 'none';
            updateAdminNavButtons('📋 Mis Eventos');
            renderUserEvents();
        }

        function showMyStats() {
            document.getElementById('addForm').style.display = 'none';
            document.getElementById('eventList').style.display = 'none';
            document.getElementById('myStats').style.display = 'block';
            updateAdminNavButtons('📊 Estadísticas');
            renderMyStats();
        }

        function updateAdminNavButtons(activeText) {
            document.querySelectorAll('#adminPanel .admin-nav button').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent.includes(activeText)) {
                    btn.classList.add('active');
                }
            });
        }

        function saveEvent(event) {
            event.preventDefault();
            
            // Verificar que el usuario esté logueado como administrador municipal
            if (!currentUser || currentUserType !== 'municipal') {
                showMessage('❌ Error: Debe estar logueado como administrador municipal para agregar eventos', 'error', 'adminMessages');
                return;
            }

            // Recopilar todos los datos del formulario
            const eventData = {
                id: editingEventId || Date.now(), // Si está editando, mantener ID; si no, crear nuevo
                title: document.getElementById('title').value.trim(),
                date: document.getElementById('date').value,
                time: document.getElementById('time').value,
                type: document.getElementById('type').value,
                cost: document.getElementById('cost').value.trim(),
                contact: document.getElementById('contact').value.trim(),
                location: document.getElementById('location').value.trim(),
                organizer: document.getElementById('organizer').value.trim(),
                description: document.getElementById('description').value.trim(),
                municipality: users[currentUser].municipality,
                createdBy: currentUser,
                created: editingEventId ? events.find(e => e.id === editingEventId)?.created || new Date().toISOString() : new Date().toISOString(),
                updated: new Date().toISOString()
            };

            // Guardar en Firestore
            saveEventToFirestore(eventData).then(success => {
                if (success) {
                    // Actualizar array local
                    if (editingEventId) {
                        // Actualizar evento existente
                        const index = events.findIndex(e => e.id === editingEventId);
                        if (index !== -1) {
                            events[index] = eventData;
                        }
                        showMessage('✅ ¡Perfecto! Evento actualizado correctamente. Ya está visible en el calendario.', 'success', 'adminMessages');
                    } else {
                        // Crear nuevo evento
                        events.push(eventData);
                        showMessage('✅ ¡Excelente! Evento creado correctamente. Ya está visible en el calendario público.', 'success', 'adminMessages');
                    }

                    // Limpiar formulario y actualizar interface
                    document.querySelector('#addForm form').reset();
                    setDefaultDate(); // Volver a poner la fecha de hoy por defecto
                    renderCalendar(); // Actualizar el calendario
                    editingEventId = null; // Limpiar modo edición
                } else {
                    showMessage('❌ Error guardando evento. Revisa tu conexión e intenta de nuevo.', 'error', 'adminMessages');
                }
            });
        }

        function editEvent(id) {
            const event = events.find(e => e.id === id);
            if (!event) return;

            document.getElementById('title').value = event.title;
            document.getElementById('date').value = event.date;
            document.getElementById('time').value = event.time;
            document.getElementById('type').value = event.type;
            document.getElementById('cost').value = event.cost;
            document.getElementById('contact').value = event.contact;
            document.getElementById('location').value = event.location;
            document.getElementById('organizer').value = event.organizer;
            document.getElementById('description').value = event.description;

            editingEventId = id;
            showAddForm();
            showMessage('✏️ Editando evento. Modifica los campos y guarda.', 'info', 'adminMessages');
        }

        function deleteEvent(id) {
            if (confirm('¿Estás seguro de eliminar este evento?')) {
                // Eliminar de Firestore
                deleteEventFromFirestore(id).then(success => {
                    if (success) {
                        // Actualizar array local
                        events = events.filter(e => e.id !== id);
                        showMessage('✅ Evento eliminado', 'success', 'adminMessages');
                        renderUserEvents();
                        renderCalendar();
                    } else {
                        showMessage('❌ Error eliminando evento', 'error', 'adminMessages');
                    }
                });
            }
        }

        function renderUserEvents() {
            if (!currentUser) return;
            
            let userEvents = events.filter(e => e.createdBy === currentUser);
            
            // Apply filter
            const now = new Date();
            now.setHours(0, 0, 0, 0);
            
            if (currentFilter === 'upcoming') {
                userEvents = userEvents.filter(e => new Date(e.date) >= now);
            } else if (currentFilter === 'past') {
                userEvents = userEvents.filter(e => new Date(e.date) < now);
            }
            
            userEvents.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            const container = document.getElementById('userEvents');
            
            if (userEvents.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 2rem;">No tienes eventos en esta categoría.</p>';
                return;
            }
            
            container.innerHTML = userEvents.map(event => `
                <div class="event-card">
                    <div>
                        <h3>${event.title}</h3>
                        <div class="event-meta">
                            <p><strong>📅 Fecha:</strong> ${formatDate(event.date)}</p>
                            <p><strong>⏰ Hora:</strong> ${event.time}</p>
                            <p><strong>🏷️ Tipo:</strong> ${getTypeIcon(event.type)} ${capitalizeFirst(event.type)}</p>
                            <p><strong>📍 Ubicación:</strong> ${event.location}</p>
                            <p><strong>💰 Costo:</strong> ${event.cost}</p>
                            <p><strong>📞 Contacto:</strong> ${event.contact}</p>
                        </div>
                        <p><strong>📋 Descripción:</strong> ${event.description}</p>
                    </div>
                    <div class="event-actions">
                        <button class="btn-small btn" onclick="editEvent(${event.id})">✏️ Editar</button>
                        <button class="btn-small btn-danger" onclick="deleteEvent(${event.id})">🗑️ Eliminar</button>
                    </div>
                </div>
            `).join('');
        }

        function renderMyStats() {
            if (!currentUser) return;
            
            const myEvents = events.filter(e => e.createdBy === currentUser);
            const now = new Date();
            now.setHours(0, 0, 0, 0);
            
            const upcoming = myEvents.filter(e => new Date(e.date) >= now).length;
            const past = myEvents.filter(e => new Date(e.date) < now).length;
            
            const byType = {};
            myEvents.forEach(event => {
                byType[event.type] = (byType[event.type] || 0) + 1;
            });
            
            const mostPopularType = Object.entries(byType).sort((a, b) => b[1] - a[1])[0];

            document.getElementById('myStatsContainer').innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${myEvents.length}</div>
                    <div class="stat-label">📅 Total de Eventos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${upcoming}</div>
                    <div class="stat-label">⏭️ Próximos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${past}</div>
                    <div class="stat-label">⏮️ Pasados</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${mostPopularType ? mostPopularType[1] : 0}</div>
                    <div class="stat-label">${mostPopularType ? `${getTypeIcon(mostPopularType[0])} Más Frecuente` : '🏷️ Tipo Popular'}</div>
                </div>
            `;
        }

        // Calendar
        function renderCalendar() {
            const calendar = document.getElementById('calendar');
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            // Update month display
            document.getElementById('currentMonth').textContent = 
                new Date(year, month).toLocaleDateString('es-MX', { month: 'long', year: 'numeric' });
            
            calendar.innerHTML = '';
            
            // Day headers
            const dayHeaders = ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'];
            dayHeaders.forEach(day => {
                const header = document.createElement('div');
                header.className = 'day-header';
                header.textContent = day;
                calendar.appendChild(header);
            });
            
            // Calendar days
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDay = firstDay.getDay();
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // Previous month days
            const prevMonth = new Date(year, month - 1, 0);
            const daysInPrevMonth = prevMonth.getDate();
            
            for (let i = startingDay - 1; i >= 0; i--) {
                const dayDiv = document.createElement('div');
                dayDiv.className = 'day other-month';
                dayDiv.innerHTML = `<div class="day-number">${daysInPrevMonth - i}</div>`;
                calendar.appendChild(dayDiv);
            }
            
            // Current month days
            for (let day = 1; day <= daysInMonth; day++) {
                const dayDiv = document.createElement('div');
                dayDiv.className = 'day';
                
                const dayDate = new Date(year, month, day);
                if (dayDate.getTime() === today.getTime()) {
                    dayDiv.classList.add('today');
                }
                
                dayDiv.innerHTML = `<div class="day-number">${day}</div>`;
                
                // Add events for this day
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                let dayEvents = events.filter(e => e.date === dateStr);
                
                // Apply filter
                if (currentFilter !== 'all') {
                    dayEvents = dayEvents.filter(e => e.type === currentFilter);
                }
                
                dayEvents.forEach(event => {
                    const eventDiv = document.createElement('div');
                    eventDiv.className = `event ${event.type}`;
                    eventDiv.textContent = event.title;
                    eventDiv.title = `${event.title} - ${event.time}`;
                    eventDiv.onclick = () => showEventDetails(event);
                    dayDiv.appendChild(eventDiv);
                });
                
                calendar.appendChild(dayDiv);
            }
            
            // Next month days
            const totalCells = 42; // 6 rows * 7 days
            const remainingCells = totalCells - (startingDay + daysInMonth);
            
            for (let day = 1; day <= remainingCells; day++) {
                const dayDiv = document.createElement('div');
                dayDiv.className = 'day other-month';
                dayDiv.innerHTML = `<div class="day-number">${day}</div>`;
                calendar.appendChild(dayDiv);
            }
        }

        function previousMonth() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
            
            // Haptic feedback on mobile
            if ('vibrate' in navigator) {
                navigator.vibrate(50);
            }
        }

        function nextMonth() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
            
            // Haptic feedback on mobile
            if ('vibrate' in navigator) {
                navigator.vibrate(50);
            }
        }

        function filterCalendar(type) {
            currentFilter = type;
            document.querySelectorAll('.calendar-section .filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            renderCalendar();
        }

        function filterEvents(filter) {
            currentFilter = filter;
            document.querySelectorAll('#eventList .filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            renderUserEvents();
        }

        // Event Details Modal
        function showEventDetails(event) {
            const modal = document.getElementById('eventModal');
            const details = document.getElementById('eventDetails');
            
            details.innerHTML = `
                <h2 style="color: #764ba2; margin-bottom: 1rem;">${event.title}</h2>
                <div class="event-meta" style="margin-bottom: 1rem;">
                    <p><strong>📅 Fecha:</strong> ${formatDate(event.date)}</p>
                    <p><strong>⏰ Hora:</strong> ${event.time}</p>
                    <p><strong>🏷️ Tipo:</strong> ${getTypeIcon(event.type)} ${capitalizeFirst(event.type)}</p>
                    <p><strong>📍 Ubicación:</strong> ${event.location}</p>
                    <p><strong>💰 Costo:</strong> ${event.cost}</p>
                    <p><strong>📞 Contacto:</strong> ${event.contact}</p>
                    <p><strong>🏢 Organizador:</strong> ${event.organizer}</p>
                </div>
                <div style="background: #f8f9ff; padding: 1rem; border-radius: 10px;">
                    <h4 style="color: #764ba2; margin-bottom: 0.5rem;">📋 Descripción:</h4>
                    <p>${event.description}</p>
                </div>
            `;
            
            modal.style.display = 'block';
        }

        function closeEventModal() {
            document.getElementById('eventModal').style.display = 'none';
        }

        // Data Import/Export - Ahora trabaja con Firestore
        function exportData() {
            const data = {
                events: events,
                users: users,
                exported: new Date().toISOString(),
                version: '2.0',
                source: 'Firebase Firestore'
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `perlas-conchos-backup-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showMessage('✅ Respaldo descargado exitosamente', 'success', 'messages');
        }

        async function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (data.events && data.users) {
                        if (confirm('⚠️ ¿Estás seguro? Esto reemplazará todos los datos actuales en Firebase.')) {
                            showMessage('🔄 Importando datos a Firebase...', 'info', 'messages');
                            
                            // Eliminar todos los eventos existentes
                            const deleteEventPromises = events.map(event => deleteEventFromFirestore(event.id));
                            await Promise.all(deleteEventPromises);
                            
                            // Eliminar todos los usuarios existentes
                            const deleteUserPromises = Object.keys(users).map(username => deleteUserFromFirestore(username));
                            await Promise.all(deleteUserPromises);
                            
                            // Agregar nuevos eventos
                            const addEventPromises = data.events.map(event => saveEventToFirestore(event));
                            await Promise.all(addEventPromises);
                            
                            // Agregar nuevos usuarios
                            const addUserPromises = Object.entries(data.users).map(([username, userData]) => 
                                saveUserToFirestore(username, userData)
                            );
                            await Promise.all(addUserPromises);
                            
                            // Recargar datos desde Firebase
                            await loadEvents();
                            await loadAuthorizedUsers();
                            
                            renderCalendar();
                            renderUserList();
                            showMessage('✅ Datos importados exitosamente desde respaldo', 'success', 'messages');
                        }
                    } else {
                        showMessage('❌ Archivo de respaldo inválido', 'error', 'messages');
                    }
                } catch (error) {
                    console.error('Error importando:', error);
                    showMessage('❌ Error al leer el archivo: ' + error.message, 'error', 'messages');
                }
            };
            reader.readAsText(file);
            
            // Reset file input
            event.target.value = '';
        }

        // Utility Functions
        function formatDate(dateStr) {
            const date = new Date(dateStr + 'T00:00:00');
            return date.toLocaleDateString('es-MX', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        function formatDateTime(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('es-MX', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function capitalizeFirst(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

        function getTypeIcon(type) {
            const icons = {
                turistico: '🏞️',
                cultural: '🎭',
                gastronomico: '🍽️',
                deportivo: '⚽',
                religioso: '⛪',
                educativo: '📚',
                comercial: '🛍️'
            };
            return icons[type] || '📅';
        }

        function showMessage(message, type, containerId = 'messages') {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.textContent = message;
            container.innerHTML = '';
            container.appendChild(messageDiv);
            
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.remove();
                }
            }, 5000);
        }

        function clearMessages() {
            ['messages', 'adminMessages'].forEach(id => {
                const container = document.getElementById(id);
                if (container) container.innerHTML = '';
            });
        }

        function clearForm() {
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            document.getElementById('superUsername').value = '';
            document.getElementById('superPassword').value = '';
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            const modals = ['loginModal', 'superAdminLoginModal', 'eventModal', 'helpModal'];
            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }

        // 🌊 PERLAS DEL CONCHOS - SISTEMA COMPLETAMENTE CARGADO CON FIREBASE FIRESTORE
        // Este sistema permite a los municipios gestionar eventos públicos usando Firebase como base de datos
        // CARACTERÍSTICAS:
        // - Base de datos compartida (Firebase Firestore)
        // - Sincronización en tiempo real entre todos los dispositivos
        // - Eventos visibles inmediatamente para todo el público
        // - Sistema de respaldo y restauración
        // - Optimizado para móviles y computadoras
        // Para soporte técnico, consulta la documentación o contacta al desarrollador
        console.log('🌊 Perlas del Conchos - Sistema completamente cargado con Firebase Firestore');
    </script>
</body>
</html>
