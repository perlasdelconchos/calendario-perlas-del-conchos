<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perlas del Conchos - Calendario de Eventos</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 1rem;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 2rem;
            border-radius: 20px;
            margin-bottom: 2rem;
            text-align: center;
            position: relative;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #764ba2;
            font-size: 2.8rem;
            margin-bottom: 0.5rem;
            font-weight: 700;
        }

        .header p {
            color: #667eea;
            font-size: 1.3rem;
            font-weight: 500;
        }

        .admin-buttons {
            position: absolute;
            top: 1rem;
            right: 1rem;
            display: flex;
            gap: 0.5rem;
        }

        .admin-btn {
            background: #764ba2;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .admin-btn:hover {
            background: #6c5ce7;
            transform: translateY(-2px);
        }

        .super-admin-btn {
            background: #e74c3c;
        }

        .super-admin-btn:hover {
            background: #c0392b;
        }

        .calendar-section {
            background: rgba(255, 255, 255, 0.95);
            padding: 2rem;
            border-radius: 20px;
            margin-bottom: 2rem;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .calendar-nav {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .nav-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 0.75rem 1rem;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .nav-btn:hover {
            background: #5a67d8;
            transform: translateY(-2px);
        }

        .current-month {
            font-size: 1.5rem;
            font-weight: 700;
            color: #764ba2;
            min-width: 200px;
            text-align: center;
        }

        .calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            background: #e0e7ff;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .day-header {
            background: #667eea;
            color: white;
            padding: 1rem;
            text-align: center;
            font-weight: 700;
            font-size: 1rem;
        }

        .day {
            background: white;
            padding: 0.75rem 0.5rem;
            min-height: 120px;
            position: relative;
            transition: all 0.3s ease;
        }

        .day:hover {
            background: #f8f9ff;
        }

        .day-number {
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: #333;
        }

        .day.other-month {
            opacity: 0.3;
        }

        .day.today {
            background: linear-gradient(135deg, #667eea, #764ba2);
        }

        .day.today .day-number {
            color: white;
        }

        .event {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 0.25rem 0.5rem;
            margin-bottom: 0.25rem;
            border-radius: 8px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .event:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .event.turistico { background: linear-gradient(135deg, #48bb78, #38a169); }
        .event.cultural { background: linear-gradient(135deg, #ed8936, #dd6b20); }
        .event.gastronomico { background: linear-gradient(135deg, #f56565, #e53e3e); }
        .event.deportivo { background: linear-gradient(135deg, #4299e1, #3182ce); }
        .event.religioso { background: linear-gradient(135deg, #805ad5, #6b46c1); }
        .event.educativo { background: linear-gradient(135deg, #38b2ac, #319795); }
        .event.comercial { background: linear-gradient(135deg, #ecc94b, #d69e2e); }

        .admin-panel {
            background: rgba(255, 255, 255, 0.95);
            padding: 2rem;
            border-radius: 20px;
            margin-bottom: 2rem;
            display: none;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            border-bottom: 3px solid #e0e7ff;
            padding-bottom: 1rem;
        }

        .admin-nav {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .admin-nav button {
            background: #667eea;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .admin-nav button:hover {
            background: #5a67d8;
            transform: translateY(-2px);
        }

        .admin-nav button.active {
            background: #764ba2;
        }

        .logout-btn {
            background: #e53e3e !important;
        }

        .logout-btn:hover {
            background: #c53030 !important;
        }

        .form-section {
            background: #f8f9ff;
            padding: 2rem;
            border-radius: 15px;
            margin-bottom: 2rem;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #4a5568;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 0.875rem;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .btn:hover {
            background: #5a67d8;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #e53e3e;
        }

        .btn-danger:hover {
            background: #c53030;
        }

        .event-list {
            display: grid;
            gap: 1rem;
        }

        .event-card {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 15px;
            padding: 1.5rem;
            transition: all 0.3s ease;
        }

        .event-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .event-card h3 {
            color: #764ba2;
            margin-bottom: 1rem;
            font-size: 1.25rem;
        }

        .event-meta {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .event-meta p {
            color: #4a5568;
            font-size: 0.9rem;
        }

        .event-meta strong {
            color: #2d3748;
        }

        .event-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            border-radius: 8px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 2rem;
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .close {
            float: right;
            font-size: 2rem;
            font-weight: bold;
            cursor: pointer;
            color: #aaa;
            transition: color 0.3s ease;
        }

        .close:hover {
            color: #333;
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-top: 1rem;
        }

        .login-form input {
            padding: 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1rem;
        }

        .message {
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 1rem;
            font-weight: 600;
        }

        .success {
            background: #c6f6d5;
            color: #2f855a;
            border: 2px solid #9ae6b4;
        }

        .error {
            background: #fed7d7;
            color: #c53030;
            border: 2px solid #feb2b2;
        }

        .info {
            background: #bee3f8;
            color: #2b6cb0;
            border: 2px solid #90cdf4;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 1.5rem;
            border-radius: 15px;
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .user-management {
            background: #f8f9ff;
            padding: 2rem;
            border-radius: 15px;
            margin-bottom: 2rem;
        }

        .user-list {
            display: grid;
            gap: 1rem;
        }

        .user-card {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .filters {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .filter-btn {
            background: white;
            border: 2px solid #667eea;
            color: #667eea;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .filter-btn.active,
        .filter-btn:hover {
            background: #667eea;
            color: white;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .admin-buttons {
                position: static;
                margin-top: 1rem;
                justify-content: center;
            }
            
            .admin-header {
                flex-direction: column;
                gap: 1rem;
            }
            
            .admin-nav {
                justify-content: center;
            }
            
            .calendar {
                font-size: 0.9rem;
            }
            
            .day {
                min-height: 80px;
                padding: 0.5rem 0.25rem;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>🌊 Perlas del Conchos</h1>
            <p>Calendario de Eventos - Región Centro Sur</p>
            <div class="admin-buttons" id="adminButtons" style="display: none;">
                <button class="admin-btn" onclick="showLogin()">👤 Admin Municipal</button>
                <button class="admin-btn super-admin-btn" onclick="showSuperAdminLogin()">⚙️ Super Admin</button>
            </div>
            <!-- Show admin buttons only when accessed directly -->
            <div style="position: absolute; bottom: 10px; right: 10px;">
                <button onclick="toggleAdminAccess()" style="background: transparent; border: none; color: #999; font-size: 0.8rem; cursor: pointer; opacity: 0.3;">⚙️</button>
            </div>
        </div>

        <!-- Super Admin Panel -->
        <div class="admin-panel" id="superAdminPanel">
            <div class="admin-header">
                <div>
                    <h2 style="color: #e74c3c;">🔧 Panel Super Administrador</h2>
                    <p style="color: #667eea;">Gestión de usuarios y sistema</p>
                </div>
                <div class="admin-nav">
                    <button onclick="showUserManagement()" class="active">👥 Usuarios</button>
                    <button onclick="showSystemStats()">📊 Estadísticas</button>
                    <button onclick="showBackup()">💾 Respaldo</button>
                    <button onclick="backToPublic()">🏠 Ver Calendario Público</button>
                    <button class="logout-btn" onclick="logout()">Salir</button>
                </div>
            </div>

            <div id="messages"></div>

            <!-- User Management -->
            <div id="userManagement">
                <div class="user-management">
                    <h3 style="color: #764ba2; margin-bottom: 1.5rem;">👥 Gestión de Usuarios</h3>
                    
                    <!-- Add User Form -->
                    <div class="form-section">
                        <h4 style="margin-bottom: 1rem;">➕ Agregar Nuevo Usuario</h4>
                        <form onsubmit="addUser(event)">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>Usuario *</label>
                                    <input type="text" id="newUsername" placeholder="ej: delicias" required>
                                </div>
                                <div class="form-group">
                                    <label>Contraseña *</label>
                                    <input type="password" id="newPassword" placeholder="Contraseña segura" required>
                                </div>
                                <div class="form-group">
                                    <label>Municipio *</label>
                                    <input type="text" id="newMunicipality" placeholder="ej: Delicias" required>
                                </div>
                                <div class="form-group">
                                    <label>Nombre Completo *</label>
                                    <input type="text" id="newDisplayName" placeholder="ej: Administrador Delicias" required>
                                </div>
                            </div>
                            <button type="submit" class="btn">➕ Agregar Usuario</button>
                        </form>
                    </div>

                    <!-- User List -->
                    <div>
                        <h4 style="margin-bottom: 1rem;">📋 Usuarios Registrados</h4>
                        <div id="userList" class="user-list"></div>
                    </div>
                </div>
            </div>

            <!-- System Stats -->
            <div id="systemStats" style="display: none;">
                <h3 style="color: #764ba2; margin-bottom: 1.5rem;">📊 Estadísticas del Sistema</h3>
                <div class="stats-grid" id="statsContainer"></div>
            </div>

            <!-- Backup -->
            <div id="backupSection" style="display: none;">
                <h3 style="color: #764ba2; margin-bottom: 1.5rem;">💾 Respaldo y Restauración</h3>
                <div class="form-section">
                    <button class="btn" onclick="exportData()">📥 Descargar Respaldo</button>
                    <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">
                    <button class="btn" onclick="document.getElementById('importFile').click()">📤 Importar Respaldo</button>
                </div>
            </div>
        </div>

        <!-- Admin Panel -->
        <div class="admin-panel" id="adminPanel">
            <div class="admin-header">
                <div>
                    <h2 style="color: #764ba2;">📋 Panel Municipal</h2>
                    <p style="color: #667eea;" id="userInfo">Usuario conectado</p>
                </div>
                <div class="admin-nav">
                    <button onclick="showAddForm()" class="active">➕ Agregar</button>
                    <button onclick="showEventList()">📋 Mis Eventos</button>
                    <button onclick="showMyStats()">📊 Estadísticas</button>
                    <button onclick="backToPublic()">🏠 Ver Calendario Público</button>
                    <button class="logout-btn" onclick="logout()">Salir</button>
                </div>
            </div>

            <div id="adminMessages"></div>

            <!-- Add Event Form -->
            <div id="addForm">
                <div class="form-section">
                    <h3 style="color: #764ba2; margin-bottom: 1.5rem;">🎉 Nuevo Evento</h3>
                    <form onsubmit="saveEvent(event)">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>📝 Título del evento *</label>
                                <input type="text" id="title" placeholder="ej: Festival de la Nuez" required>
                            </div>
                            <div class="form-group">
                                <label>📅 Fecha *</label>
                                <input type="date" id="date" required>
                            </div>
                            <div class="form-group">
                                <label>⏰ Hora *</label>
                                <input type="time" id="time" required>
                            </div>
                            <div class="form-group">
                                <label>🏷️ Tipo de evento *</label>
                                <select id="type" required>
                                    <option value="">Seleccionar tipo</option>
                                    <option value="turistico">🏞️ Turístico</option>
                                    <option value="cultural">🎭 Cultural</option>
                                    <option value="gastronomico">🍽️ Gastronómico</option>
                                    <option value="deportivo">⚽ Deportivo</option>
                                    <option value="religioso">⛪ Religioso/Tradicional</option>
                                    <option value="educativo">📚 Educativo</option>
                                    <option value="comercial">🛍️ Comercial/Feria</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>💰 Costo *</label>
                                <input type="text" id="cost" placeholder="ej: Gratuito, $100 MXN" required>
                            </div>
                            <div class="form-group">
                                <label>📞 Contacto/Teléfono *</label>
                                <input type="text" id="contact" placeholder="ej: 636-123-4567" required>
                            </div>
                            <div class="form-group full-width">
                                <label>📍 Ubicación completa *</label>
                                <input type="text" id="location" placeholder="ej: Plaza Principal, Centro Histórico" required>
                            </div>
                            <div class="form-group full-width">
                                <label>🏢 Organizador *</label>
                                <input type="text" id="organizer" placeholder="ej: Municipio de Delicias" required>
                            </div>
                            <div class="form-group full-width">
                                <label>📋 Descripción del evento *</label>
                                <textarea id="description" rows="4" placeholder="Describe el evento, actividades incluidas, etc." required></textarea>
                            </div>
                            <div class="form-group full-width" style="text-align: center;">
                                <button type="submit" class="btn">💾 Guardar Evento</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Event List -->
            <div id="eventList" style="display: none;">
                <h3 style="color: #764ba2; margin-bottom: 1.5rem;">📋 Mis Eventos</h3>
                <div class="filters">
                    <button class="filter-btn active" onclick="filterEvents('all')">📅 Todos</button>
                    <button class="filter-btn" onclick="filterEvents('upcoming')">⏭️ Próximos</button>
                    <button class="filter-btn" onclick="filterEvents('past')">⏮️ Pasados</button>
                </div>
                <div id="userEvents" class="event-list"></div>
            </div>

            <!-- My Stats -->
            <div id="myStats" style="display: none;">
                <h3 style="color: #764ba2; margin-bottom: 1.5rem;">📊 Mis Estadísticas</h3>
                <div class="stats-grid" id="myStatsContainer"></div>
            </div>
        </div>

        <!-- Calendar -->
        <div class="calendar-section">
            <div class="calendar-header">
                <h3 style="color: #764ba2;">📅 Calendario de Eventos Públicos</h3>
                <div class="calendar-nav">
                    <button class="nav-btn" onclick="previousMonth()">← Anterior</button>
                    <div class="current-month" id="currentMonth"></div>
                    <button class="nav-btn" onclick="nextMonth()">Siguiente →</button>
                </div>
            </div>
            
            <!-- Event Type Filters -->
            <div class="filters">
                <button class="filter-btn active" onclick="filterCalendar('all')">📅 Todos</button>
                <button class="filter-btn" onclick="filterCalendar('turistico')">🏞️ Turístico</button>
                <button class="filter-btn" onclick="filterCalendar('cultural')">🎭 Cultural</button>
                <button class="filter-btn" onclick="filterCalendar('gastronomico')">🍽️ Gastronómico</button>
                <button class="filter-btn" onclick="filterCalendar('deportivo')">⚽ Deportivo</button>
                <button class="filter-btn" onclick="filterCalendar('religioso')">⛪ Religioso</button>
                <button class="filter-btn" onclick="filterCalendar('educativo')">📚 Educativo</button>
                <button class="filter-btn" onclick="filterCalendar('comercial')">🛍️ Comercial</button>
            </div>
            
            <div class="calendar" id="calendar">
                <!-- Calendar generated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Login Modals -->
    <div id="loginModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeLogin()">&times;</span>
            <h2 style="color: #764ba2; text-align: center;">👤 Acceso Municipal</h2>
            <form class="login-form" onsubmit="login(event)">
                <input type="text" id="username" placeholder="Usuario del municipio" required>
                <input type="password" id="password" placeholder="Contraseña" required>
                <button type="submit" class="btn">Ingresar</button>
            </form>
            <div style="margin-top: 1rem; padding: 1rem; background: #e6fffa; border-radius: 8px; font-size: 0.9rem;">
                <strong>ℹ️ Para obtener acceso:</strong><br>
                Contacta al administrador del sistema para que te asigne un usuario y contraseña.<br><br>
                <strong>Usuario de prueba:</strong><br>
                Usuario: delicias<br>
                Contraseña: 123
            </div>
        </div>
    </div>

    <div id="superAdminLoginModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeSuperAdminLogin()">&times;</span>
            <h2 style="color: #e74c3c; text-align: center;">⚙️ Super Administrador</h2>
            <form class="login-form" onsubmit="superAdminLogin(event)">
                <input type="text" id="superUsername" placeholder="Usuario administrador" required>
                <input type="password" id="superPassword" placeholder="Contraseña maestra" required>
                <button type="submit" class="btn">Ingresar</button>
            </form>
            <div style="margin-top: 1rem; padding: 1rem; background: #fff5f5; border-radius: 8px; font-size: 0.9rem;">
                <strong>⚠️ Acceso restringido:</strong><br>
                Solo para el administrador principal del sistema.<br><br>
                <strong>Credenciales de prueba:</strong><br>
                Usuario: admin<br>
                Contraseña: perlas2024!
            </div>
        </div>
    </div>

    <!-- Event Detail Modal -->
    <div id="eventModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeEventModal()">&times;</span>
            <div id="eventDetails"></div>
        </div>
    </div>

    <script>
        // Variables globales
        let currentUser = null;
        let currentUserType = null; // 'municipal' or 'super'
        let events = [];
        let users = {};
        let currentDate = new Date();
        let currentFilter = 'all';
        let editingEventId = null;

        // Super admin credentials (cambiar estas credenciales por seguridad)
        const SUPER_ADMIN = {
            username: 'admin',
            password: 'perlas2024!'
        };

        // Inicializar aplicación
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🌊 Perlas del Conchos - Sistema iniciado');
            loadData();
            renderCalendar();
            setDefaultDate();
        });

        // Gestión de datos
        function loadData() {
            const savedEvents = localStorage.getItem('perlasEvents');
            const savedUsers = localStorage.getItem('perlasUsers');
            
            events = savedEvents ? JSON.parse(savedEvents) : [];
            users = savedUsers ? JSON.parse(savedUsers) : {
                'delicias': {
                    password: '123',
                    municipality: 'Delicias',
                    displayName: 'Administrador Delicias',
                    active: true,
                    created: new Date().toISOString()
                }
            };
            
            console.log(`📊 Datos cargados: ${events.length} eventos, ${Object.keys(users).length} usuarios`);
        }

        function saveData() {
            localStorage.setItem('perlasEvents', JSON.stringify(events));
            localStorage.setItem('perlasUsers', JSON.stringify(users));
            console.log('💾 Datos guardados exitosamente');
        }

        function setDefaultDate() {
            const today = new Date();
            const dateStr = today.toISOString().split('T')[0];
            const dateInput = document.getElementById('date');
            if (dateInput) {
                dateInput.value = dateStr;
            }
        }

        // Authentication
        function toggleAdminAccess() {
            const adminButtons = document.getElementById('adminButtons');
            if (adminButtons.style.display === 'none') {
                adminButtons.style.display = 'flex';
                showMessage('🔐 Acceso administrativo habilitado', 'info');
            } else {
                adminButtons.style.display = 'none';
                showMessage('👥 Modo público activado', 'info');
            }
        }

        function showLogin() {
            document.getElementById('loginModal').style.display = 'block';
        }

        function closeLogin() {
            document.getElementById('loginModal').style.display = 'none';
            clearMessages();
        }

        function showSuperAdminLogin() {
            document.getElementById('superAdminLoginModal').style.display = 'block';
        }

        function closeSuperAdminLogin() {
            document.getElementById('superAdminLoginModal').style.display = 'none';
            clearMessages();
        }

        function backToPublic() {
            // Hide all admin panels
            document.getElementById('adminPanel').style.display = 'none';
            document.getElementById('superAdminPanel').style.display = 'none';
            
            // Show calendar section
            document.querySelector('.calendar-section').style.display = 'block';
            
            // Hide admin buttons
            document.getElementById('adminButtons').style.display = 'none';
            
            showMessage('🏠 Volviendo al calendario público', 'info');
        }

        function login(event) {
            event.preventDefault();
            const username = document.getElementById('username').value.trim().toLowerCase();
            const password = document.getElementById('password').value;

            if (users[username] && users[username].password === password && users[username].active) {
                currentUser = username;
                currentUserType = 'municipal';
                document.getElementById('userInfo').textContent = 
                    `${users[username].displayName} - ${users[username].municipality}`;
                
                // Hide calendar and show admin panel
                document.querySelector('.calendar-section').style.display = 'none';
                document.getElementById('adminPanel').style.display = 'block';
                
                closeLogin();
                showMessage('✅ Acceso exitoso', 'success', 'adminMessages');
                showAddForm();
                clearForm();
            } else {
                showMessage('❌ Usuario o contraseña incorrectos', 'error');
            }
        }

        function superAdminLogin(event) {
            event.preventDefault();
            const username = document.getElementById('superUsername').value.trim();
            const password = document.getElementById('superPassword').value;

            if (username === SUPER_ADMIN.username && password === SUPER_ADMIN.password) {
                currentUser = 'superadmin';
                currentUserType = 'super';
                
                // Hide calendar and show super admin panel
                document.querySelector('.calendar-section').style.display = 'none';
                document.getElementById('superAdminPanel').style.display = 'block';
                
                closeSuperAdminLogin();
                showMessage('✅ Acceso de super administrador exitoso', 'success', 'messages');
                showUserManagement();
                renderUserList();
                clearForm();
            } else {
                showMessage('❌ Credenciales de super administrador incorrectas', 'error');
            }
        }

        function logout() {
            currentUser = null;
            currentUserType = null;
            
            // Hide admin panels and show calendar
            document.getElementById('adminPanel').style.display = 'none';
            document.getElementById('superAdminPanel').style.display = 'none';
            document.querySelector('.calendar-section').style.display = 'block';
            
            // Hide admin buttons
            document.getElementById('adminButtons').style.display = 'none';
            
            showMessage('👋 Sesión cerrada exitosamente', 'success');
            clearForm();
        }

        // User Management (Super Admin)
        function showUserManagement() {
            document.getElementById('userManagement').style.display = 'block';
            document.getElementById('systemStats').style.display = 'none';
            document.getElementById('backupSection').style.display = 'none';
            updateNavButtons('👥 Usuarios');
            renderUserList();
        }

        function showSystemStats() {
            document.getElementById('userManagement').style.display = 'none';
            document.getElementById('systemStats').style.display = 'block';
            document.getElementById('backupSection').style.display = 'none';
            updateNavButtons('📊 Estadísticas');
            renderSystemStats();
        }

        function showBackup() {
            document.getElementById('userManagement').style.display = 'none';
            document.getElementById('systemStats').style.display = 'none';
            document.getElementById('backupSection').style.display = 'block';
            updateNavButtons('💾 Respaldo');
        }

        function updateNavButtons(activeText) {
            document.querySelectorAll('#superAdminPanel .admin-nav button').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent.includes(activeText)) {
                    btn.classList.add('active');
                }
            });
        }

        function addUser(event) {
            event.preventDefault();
            
            const username = document.getElementById('newUsername').value.trim().toLowerCase();
            const password = document.getElementById('newPassword').value;
            const municipality = document.getElementById('newMunicipality').value.trim();
            const displayName = document.getElementById('newDisplayName').value.trim();

            if (users[username]) {
                showMessage('❌ El usuario ya existe', 'error', 'messages');
                return;
            }

            users[username] = {
                password: password,
                municipality: municipality,
                displayName: displayName,
                active: true,
                created: new Date().toISOString()
            };

            saveData();
            showMessage(`✅ Usuario "${username}" creado exitosamente`, 'success', 'messages');
            document.querySelector('#userManagement form').reset();
            renderUserList();
        }

        function toggleUser(username) {
            if (users[username]) {
                users[username].active = !users[username].active;
                saveData();
                showMessage(`✅ Usuario "${username}" ${users[username].active ? 'activado' : 'desactivado'}`, 'success', 'messages');
                renderUserList();
            }
        }

        function deleteUser(username) {
            if (confirm(`¿Estás seguro de eliminar al usuario "${username}"?`)) {
                delete users[username];
                
                // Also delete events from this user
                events = events.filter(event => event.createdBy !== username);
                
                saveData();
                showMessage(`✅ Usuario "${username}" eliminado`, 'success', 'messages');
                renderUserList();
                renderCalendar();
            }
        }

        function renderUserList() {
            const container = document.getElementById('userList');
            const userEntries = Object.entries(users);

            if (userEntries.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 2rem;">No hay usuarios registrados.</p>';
                return;
            }

            container.innerHTML = userEntries.map(([username, userData]) => `
                <div class="user-card">
                    <div>
                        <h4 style="color: #764ba2;">${userData.displayName}</h4>
                        <p style="color: #666; margin: 0.25rem 0;">👤 Usuario: ${username}</p>
                        <p style="color: #666; margin: 0.25rem 0;">🏛️ Municipio: ${userData.municipality}</p>
                        <p style="color: #666; margin: 0.25rem 0;">📅 Creado: ${formatDateTime(userData.created)}</p>
                        <span style="padding: 0.25rem 0.5rem; border-radius: 5px; font-size: 0.8rem; 
                              background: ${userData.active ? '#c6f6d5' : '#fed7d7'}; 
                              color: ${userData.active ? '#2f855a' : '#c53030'};">
                            ${userData.active ? '✅ Activo' : '❌ Inactivo'}
                        </span>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                        <button class="btn-small ${userData.active ? 'btn-danger' : 'btn'}" 
                                onclick="toggleUser('${username}')">
                            ${userData.active ? '🚫 Desactivar' : '✅ Activar'}
                        </button>
                        <button class="btn-small btn-danger" onclick="deleteUser('${username}')">
                            🗑️ Eliminar
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function renderSystemStats() {
            const totalEvents = events.length;
            const totalUsers = Object.keys(users).length;
            const activeUsers = Object.values(users).filter(u => u.active).length;
            const upcomingEvents = events.filter(e => new Date(e.date) >= new Date()).length;
            
            const eventsByType = {};
            events.forEach(event => {
                eventsByType[event.type] = (eventsByType[event.type] || 0) + 1;
            });

            const eventsByMunicipality = {};
            events.forEach(event => {
                const municipality = users[event.createdBy]?.municipality || 'Desconocido';
                eventsByMunicipality[municipality] = (eventsByMunicipality[municipality] || 0) + 1;
            });

            document.getElementById('statsContainer').innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${totalEvents}</div>
                    <div class="stat-label">📅 Total de Eventos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${totalUsers}</div>
                    <div class="stat-label">👥 Total de Usuarios</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${activeUsers}</div>
                    <div class="stat-label">✅ Usuarios Activos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${upcomingEvents}</div>
                    <div class="stat-label">⏭️ Eventos Próximos</div>
                </div>
            `;
        }

        // Event Management
        function showAddForm() {
            document.getElementById('addForm').style.display = 'block';
            document.getElementById('eventList').style.display = 'none';
            document.getElementById('myStats').style.display = 'none';
            updateAdminNavButtons('➕ Agregar');
            editingEventId = null;
        }

        function showEventList() {
            document.getElementById('addForm').style.display = 'none';
            document.getElementById('eventList').style.display = 'block';
            document.getElementById('myStats').style.display = 'none';
            updateAdminNavButtons('📋 Mis Eventos');
            renderUserEvents();
        }

        function showMyStats() {
            document.getElementById('addForm').style.display = 'none';
            document.getElementById('eventList').style.display = 'none';
            document.getElementById('myStats').style.display = 'block';
            updateAdminNavButtons('📊 Estadísticas');
            renderMyStats();
        }

        function updateAdminNavButtons(activeText) {
            document.querySelectorAll('#adminPanel .admin-nav button').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent.includes(activeText)) {
                    btn.classList.add('active');
                }
            });
        }

        function saveEvent(event) {
            event.preventDefault();
            
            if (!currentUser || currentUserType !== 'municipal') {
                showMessage('❌ Debe estar logueado como administrador municipal', 'error', 'adminMessages');
                return;
            }

            const eventData = {
                id: editingEventId || Date.now(),
                title: document.getElementById('title').value.trim(),
                date: document.getElementById('date').value,
                time: document.getElementById('time').value,
                type: document.getElementById('type').value,
                cost: document.getElementById('cost').value.trim(),
                contact: document.getElementById('contact').value.trim(),
                location: document.getElementById('location').value.trim(),
                organizer: document.getElementById('organizer').value.trim(),
                description: document.getElementById('description').value.trim(),
                municipality: users[currentUser].municipality,
                createdBy: currentUser,
                created: editingEventId ? events.find(e => e.id === editingEventId).created : new Date().toISOString(),
                updated: new Date().toISOString()
            };

            if (editingEventId) {
                const index = events.findIndex(e => e.id === editingEventId);
                events[index] = eventData;
                showMessage('✅ Evento actualizado correctamente', 'success', 'adminMessages');
            } else {
                events.push(eventData);
                showMessage('✅ Evento creado correctamente', 'success', 'adminMessages');
            }

            saveData();
            document.querySelector('#addForm form').reset();
            setDefaultDate();
            renderCalendar();
            editingEventId = null;
        }

        function editEvent(id) {
            const event = events.find(e => e.id === id);
            if (!event) return;

            document.getElementById('title').value = event.title;
            document.getElementById('date').value = event.date;
            document.getElementById('time').value = event.time;
            document.getElementById('type').value = event.type;
            document.getElementById('cost').value = event.cost;
            document.getElementById('contact').value = event.contact;
            document.getElementById('location').value = event.location;
            document.getElementById('organizer').value = event.organizer;
            document.getElementById('description').value = event.description;

            editingEventId = id;
            showAddForm();
            showMessage('✏️ Editando evento. Modifica los campos y guarda.', 'info', 'adminMessages');
        }

        function deleteEvent(id) {
            if (confirm('¿Estás seguro de eliminar este evento?')) {
                events = events.filter(e => e.id !== id);
                saveData();
                showMessage('✅ Evento eliminado', 'success', 'adminMessages');
                renderUserEvents();
                renderCalendar();
            }
        }

        function renderUserEvents() {
            if (!currentUser) return;
            
            let userEvents = events.filter(e => e.createdBy === currentUser);
            
            // Apply filter
            const now = new Date();
            now.setHours(0, 0, 0, 0);
            
            if (currentFilter === 'upcoming') {
                userEvents = userEvents.filter(e => new Date(e.date) >= now);
            } else if (currentFilter === 'past') {
                userEvents = userEvents.filter(e => new Date(e.date) < now);
            }
            
            userEvents.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            const container = document.getElementById('userEvents');
            
            if (userEvents.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 2rem;">No tienes eventos en esta categoría.</p>';
                return;
            }
            
            container.innerHTML = userEvents.map(event => `
                <div class="event-card">
                    <div>
                        <h3>${event.title}</h3>
                        <div class="event-meta">
                            <p><strong>📅 Fecha:</strong> ${formatDate(event.date)}</p>
                            <p><strong>⏰ Hora:</strong> ${event.time}</p>
                            <p><strong>🏷️ Tipo:</strong> ${getTypeIcon(event.type)} ${capitalizeFirst(event.type)}</p>
                            <p><strong>📍 Ubicación:</strong> ${event.location}</p>
                            <p><strong>💰 Costo:</strong> ${event.cost}</p>
                            <p><strong>📞 Contacto:</strong> ${event.contact}</p>
                        </div>
                        <p><strong>📋 Descripción:</strong> ${event.description}</p>
                    </div>
                    <div class="event-actions">
                        <button class="btn-small btn" onclick="editEvent(${event.id})">✏️ Editar</button>
                        <button class="btn-small btn-danger" onclick="deleteEvent(${event.id})">🗑️ Eliminar</button>
                    </div>
                </div>
            `).join('');
        }

        function renderMyStats() {
            if (!currentUser) return;
            
            const myEvents = events.filter(e => e.createdBy === currentUser);
            const now = new Date();
            now.setHours(0, 0, 0, 0);
            
            const upcoming = myEvents.filter(e => new Date(e.date) >= now).length;
            const past = myEvents.filter(e => new Date(e.date) < now).length;
            
            const byType = {};
            myEvents.forEach(event => {
                byType[event.type] = (byType[event.type] || 0) + 1;
            });
            
            const mostPopularType = Object.entries(byType).sort((a, b) => b[1] - a[1])[0];

            document.getElementById('myStatsContainer').innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${myEvents.length}</div>
                    <div class="stat-label">📅 Total de Eventos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${upcoming}</div>
                    <div class="stat-label">⏭️ Próximos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${past}</div>
                    <div class="stat-label">⏮️ Pasados</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${mostPopularType ? mostPopularType[1] : 0}</div>
                    <div class="stat-label">${mostPopularType ? `${getTypeIcon(mostPopularType[0])} Más Frecuente` : '🏷️ Tipo Popular'}</div>
                </div>
            `;
        }

        // Calendar
        function renderCalendar() {
            const calendar = document.getElementById('calendar');
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            // Update month display
            document.getElementById('currentMonth').textContent = 
                new Date(year, month).toLocaleDateString('es-MX', { month: 'long', year: 'numeric' });
            
            calendar.innerHTML = '';
            
            // Day headers
            const dayHeaders = ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'];
            dayHeaders.forEach(day => {
                const header = document.createElement('div');
                header.className = 'day-header';
                header.textContent = day;
                calendar.appendChild(header);
            });
            
            // Calendar days
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDay = firstDay.getDay();
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // Previous month days
            const prevMonth = new Date(year, month - 1, 0);
            const daysInPrevMonth = prevMonth.getDate();
            
            for (let i = startingDay - 1; i >= 0; i--) {
                const dayDiv = document.createElement('div');
                dayDiv.className = 'day other-month';
                dayDiv.innerHTML = `<div class="day-number">${daysInPrevMonth - i}</div>`;
                calendar.appendChild(dayDiv);
            }
            
            // Current month days
            for (let day = 1; day <= daysInMonth; day++) {
                const dayDiv = document.createElement('div');
                dayDiv.className = 'day';
                
                const dayDate = new Date(year, month, day);
                if (dayDate.getTime() === today.getTime()) {
                    dayDiv.classList.add('today');
                }
                
                dayDiv.innerHTML = `<div class="day-number">${day}</div>`;
                
                // Add events for this day
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                let dayEvents = events.filter(e => e.date === dateStr);
                
                // Apply filter
                if (currentFilter !== 'all') {
                    dayEvents = dayEvents.filter(e => e.type === currentFilter);
                }
                
                dayEvents.forEach(event => {
                    const eventDiv = document.createElement('div');
                    eventDiv.className = `event ${event.type}`;
                    eventDiv.textContent = event.title;
                    eventDiv.title = `${event.title} - ${event.time}`;
                    eventDiv.onclick = () => showEventDetails(event);
                    dayDiv.appendChild(eventDiv);
                });
                
                calendar.appendChild(dayDiv);
            }
            
            // Next month days
            const totalCells = 42; // 6 rows * 7 days
            const remainingCells = totalCells - (startingDay + daysInMonth);
            
            for (let day = 1; day <= remainingCells; day++) {
                const dayDiv = document.createElement('div');
                dayDiv.className = 'day other-month';
                dayDiv.innerHTML = `<div class="day-number">${day}</div>`;
                calendar.appendChild(dayDiv);
            }
        }

        function previousMonth() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
        }

        function nextMonth() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
        }

        function filterCalendar(type) {
            currentFilter = type;
            document.querySelectorAll('.calendar-section .filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            renderCalendar();
        }

        function filterEvents(filter) {
            currentFilter = filter;
            document.querySelectorAll('#eventList .filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            renderUserEvents();
        }

        // Event Details Modal
        function showEventDetails(event) {
            const modal = document.getElementById('eventModal');
            const details = document.getElementById('eventDetails');
            
            details.innerHTML = `
                <h2 style="color: #764ba2; margin-bottom: 1rem;">${event.title}</h2>
                <div class="event-meta" style="margin-bottom: 1rem;">
                    <p><strong>📅 Fecha:</strong> ${formatDate(event.date)}</p>
                    <p><strong>⏰ Hora:</strong> ${event.time}</p>
                    <p><strong>🏷️ Tipo:</strong> ${getTypeIcon(event.type)} ${capitalizeFirst(event.type)}</p>
                    <p><strong>📍 Ubicación:</strong> ${event.location}</p>
                    <p><strong>💰 Costo:</strong> ${event.cost}</p>
                    <p><strong>📞 Contacto:</strong> ${event.contact}</p>
                    <p><strong>🏢 Organizador:</strong> ${event.organizer}</p>
                </div>
                <div style="background: #f8f9ff; padding: 1rem; border-radius: 10px;">
                    <h4 style="color: #764ba2; margin-bottom: 0.5rem;">📋 Descripción:</h4>
                    <p>${event.description}</p>
                </div>
            `;
            
            modal.style.display = 'block';
        }

        function closeEventModal() {
            document.getElementById('eventModal').style.display = 'none';
        }

        // Data Import/Export
        function exportData() {
            const data = {
                events: events,
                users: users,
                exported: new Date().toISOString(),
                version: '1.0'
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `perlas-conchos-backup-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showMessage('✅ Respaldo descargado exitosamente', 'success', 'messages');
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (data.events && data.users) {
                        if (confirm('⚠️ ¿Estás seguro? Esto reemplazará todos los datos actuales.')) {
                            events = data.events;
                            users = data.users;
                            saveData();
                            renderCalendar();
                            renderUserList();
                            showMessage('✅ Datos importados exitosamente', 'success', 'messages');
                        }
                    } else {
                        showMessage('❌ Archivo de respaldo inválido', 'error', 'messages');
                    }
                } catch (error) {
                    showMessage('❌ Error al leer el archivo: ' + error.message, 'error', 'messages');
                }
            };
            reader.readAsText(file);
            
            // Reset file input
            event.target.value = '';
        }

        // Utility Functions
        function formatDate(dateStr) {
            const date = new Date(dateStr + 'T00:00:00');
            return date.toLocaleDateString('es-MX', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        function formatDateTime(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('es-MX', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function capitalizeFirst(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

        function getTypeIcon(type) {
            const icons = {
                turistico: '🏞️',
                cultural: '🎭',
                gastronomico: '🍽️',
                deportivo: '⚽',
                religioso: '⛪',
                educativo: '📚',
                comercial: '🛍️'
            };
            return icons[type] || '📅';
        }

        function showMessage(message, type, containerId = 'messages') {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.textContent = message;
            container.innerHTML = '';
            container.appendChild(messageDiv);
            
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.remove();
                }
            }, 5000);
        }

        function clearMessages() {
            ['messages', 'adminMessages'].forEach(id => {
                const container = document.getElementById(id);
                if (container) container.innerHTML = '';
            });
        }

        function clearForm() {
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            document.getElementById('superUsername').value = '';
            document.getElementById('superPassword').value = '';
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            const modals = ['loginModal', 'superAdminLoginModal', 'eventModal'];
            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }

        console.log('🌊 Perlas del Conchos - Sistema completamente cargado');
    </script>
</body>
</html>
